<!DOCTYPE html> <html> <!-- This page is used centrarium Jekyll theme Copyright (c) 2015 Ben Centra Released under the MIT license https://github.com/bencentra/centrarium/blob/daa0d16ba9156ad43f9980e2075023a0d48859a5/LICENSE.md --> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"> <title>Designship 2021のライブ配信サイトの開発周りについて</title> <meta name="description" content="2021年10月23日、24日にデザインカンファレンスである、Designship 2021が開催されました。 今回はこのライブ配信サイトを開発する際に技術的に工夫した内容などを紹介します。"> <meta name="author" content="Tadayuki Onishi"> <meta name="copyright" content="© Tadayuki Onishi 2025"> <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon"> <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon"> <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png"> <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png"> <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png"> <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png"> <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png"> <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png"> <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/android-icon-192x192.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png"> <link rel="manifest" href="/assets/icons/manifest.json"> <meta name="msapplication-TileColor" content="#ffffff"> <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png"> <meta name="theme-color" content="#ffffff"> <meta property="fb:app_id" content="376889769419405"> <meta property="og:description" content="2021年10月23日、24日にデザインカンファレンスである、Designship 2021が開催されました。 今回はこのライブ配信サイトを開発する際に技術的に工夫した内容などを紹介します。"> <meta property="og:url" content="https://kenchan0130.github.io/post/2021-10-29-1"> <meta property="og:site_name" content="kenchan0130 blog"> <meta property="og:title" content="Designship 2021のライブ配信サイトの開発周りについて"> <meta property="og:type" content="website"> <meta property="og:author" content="Tadayuki Onishi"> <meta property="og:image" content="https://kenchan0130.github.io/assets/posts/post/2021-10-29-1/cover.png"> <meta property="og:image:width" content="1920"> <meta property="og:image:height" content="1080"> <meta property="og:image:type" content="image/png"> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="Designship 2021のライブ配信サイトの開発周りについて"> <meta name="twitter:site" content="@kenchan0130"> <meta name="twitter:description" content="2021年10月23日、24日にデザインカンファレンスである、Designship 2021が開催されました。 今回はこのライブ配信サイトを開発する際に技術的に工夫した内容などを紹介します。"> <meta name="twitter:image" content="https://kenchan0130.github.io/assets/posts/post/2021-10-29-1/cover.png"> <meta name="twitter:url" content="https://kenchan0130.github.io/post/2021-10-29-1"> <link rel="preload" as="style" href="/assets/bundle/app.6b4bd929e0a1773ddf90.css" onload="this.onload=null;this.rel='stylesheet'"> <noscript> <link rel="stylesheet" href="/assets/bundle/app.6b4bd929e0a1773ddf90.css"> </noscript> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="https://kenchan0130.github.io/post/2021-10-29-1"> <link rel="alternate" type="application/atom+xml" title="kenchan0130 blog" href="https://kenchan0130.github.io/feed.xml"> <meta name="google-site-verification" content="ZxlKORgZZwZ4TTmaQJFFEXLF3jmd6P_NVU9TEVW1bSg"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> </head> <body> <header class="navigation" role="banner"> <div class="navigation-wrapper"> <a href="/" class="logo"> <img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="kenchan0130 blog" data-src="/assets/logo.png" class="lazyload"> </a> <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu"> <i class="fas fa-bars"></i> </a> <nav role="navigation"> <ul id="js-navigation-menu" class="navigation-menu"> <li class="nav-search-box"> <div class="search-input-container"> <input type="search" class="search-input" id="js-search-input" placeholder="Search" autocomplete="off" onfocus="gtag('event', 'search', { event_category: 'www.algolia.com/apps/DEFR5IK9E2/explorer/browse/kenchan0130_blog', event_label: '/post/2021-10-29-1' });"> <i class="fa fa-search search-input-icon"></i> <template id="suggestion-template"> <a href="" onclick="gtag('event', 'click', { event_category: 'www.algolia.com/apps/DEFR5IK9E2/explorer/browse/kenchan0130_blog', event_label: this.href });"> <p class="suggestion-title js-suggestion-title"></p> <p class="suggestion-content js-suggestion-content"></p> </a> </template> </div> </li> <li class="nav-link"> <a href="/archives">Archives</a> </li> <li class="nav-link"> <a href="/profile">Profile</a> </li> </ul> </nav> </div> </header> <div class="page-content"> <div class="post"> <div class="post-header-container has-cover" style="background-image: url(/assets/posts/post/2021-10-29-1/cover.png);"> <div class="scrim has-cover"> <header class="post-header"> <h1 class="title">Designship 2021のライブ配信サイトの開発周りについて</h1> </header> </div> </div> <div class="wrapper"> <section class="post-meta"> <div class="post-date">2021-10-29</div> <div class="post-categories"> <i class="fas fa-fw fa-book"></i> <a href="/category/development">development </a> </div> </section> <article class="post-content"> <p>2021年10月23日、24日にデザインカンファレンスである、<a href="https://design-ship.jp" target="_blank" rel="noopener noreferrer">Designship 2021</a>が開催されました。</p> <p>全体の構成や機能については、<a href="https://twitter.com/__sakito__" target="_blank" rel="noopener noreferrer">sakito</a>氏の「<a href="https://zenn.dev/sakito/articles/0bd49ab90f11ea" target="_blank" rel="noopener noreferrer">デザインカンファレンスのライブ配信サイトを開発した話</a>」で紹介されています。 そのため、今回は違う切り口として、このライブ配信サイトを開発する際に技術的に工夫した内容などを紹介します。</p> <ul id="markdown-toc"> <li> <a href="#identity-platform%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F%E8%AA%8D%E8%A8%BC%E6%A9%9F%E8%83%BD%E3%81%AE%E5%AE%9F%E8%A3%85" id="markdown-toc-identity-platformを使用した認証機能の実装">Identity Platformを使用した認証機能の実装</a> <ul> <li><a href="#identity-platform%E3%81%AE%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3%E3%81%AE%E7%99%BA%E8%A1%8C%E3%81%A8%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%82%AF%E3%83%AC%E3%83%BC%E3%83%A0%E3%81%AE%E8%A8%AD%E5%AE%9A" id="markdown-toc-identity-platformのカスタムトークンの発行とカスタムクレームの設定">Identity Platformのカスタムトークンの発行とカスタムクレームの設定</a></li> <li><a href="#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E3%82%92%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%97%E3%81%A6%E3%81%84%E3%82%8Bidentity-platform%E3%81%A7%E3%81%AE%E8%AA%8D%E8%A8%BC" id="markdown-toc-マルチテナントを有効化しているidentity-platformでの認証">マルチテナントを有効化しているIdentity Platformでの認証</a></li> <li><a href="#%E5%90%8C%E4%B8%80%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%81%A7firebase-sdk%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AE%E5%B7%A5%E5%A4%AB" id="markdown-toc-同一ソースコードでfirebase-sdkを使用する場合の工夫">同一ソースコードでFirebase SDKを使用する場合の工夫</a></li> </ul> </li> <li> <a href="#%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%81%A8%E6%9C%AC%E7%95%AA%E7%92%B0%E5%A2%83%E3%81%A7%E7%95%B0%E3%81%AA%E3%82%8B%E5%80%A4%E3%82%92%E8%A8%AD%E5%AE%9A" id="markdown-toc-開発環境と本番環境で異なる値を設定">開発環境と本番環境で異なる値を設定</a> <ul> <li><a href="#runtime-configuration%E8%A8%AD%E5%AE%9A%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90" id="markdown-toc-runtime-configuration設定スクリプトの作成">Runtime Configuration設定スクリプトの作成</a></li> </ul> </li> <li> <a href="#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%81%97%E3%81%8F%E3%81%BF" id="markdown-toc-デプロイのしくみ">デプロイのしくみ</a> <ul> <li><a href="#github-actions%E3%81%A8%E5%91%A8%E8%BE%BA%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E8%A8%AD%E5%AE%9A" id="markdown-toc-github-actionsと周辺ファイル設定">GitHub Actionsと周辺ファイル設定</a></li> </ul> </li> <li> <a href="#%E3%83%8F%E3%83%9E%E3%81%A3%E3%81%9F%E3%81%93%E3%81%A8" id="markdown-toc-ハマったこと">ハマったこと</a> <ul> <li><a href="#callable-https-function%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%81%A8cors%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%A8%E3%81%AA%E3%82%8B" id="markdown-toc-callable-https-functionを使用するとcorsエラーとなる">Callable HTTPS Functionを使用するとCORSエラーとなる</a></li> </ul> </li> <li><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB" id="markdown-toc-終わりに">終わりに</a></li> </ul> <h2 id="identity-platformを使用した認証機能の実装">Identity Platformを使用した認証機能の実装</h2> <p>今回のカンファレンスは有料であるため、参加者のみがライブ配信サイトに入れるという機能が必要です。</p> <p>具体的には、チケット購入者、スポンサー様には事前にパスコードが発行されます。 そのパスコードと一致した場合、サイトにログインできるようにしていました。</p> <p>インフラ基盤としてFirebaseを使用している場合、認証機能はFirebase Authenticationを選択することが多いですが、今回はGCPの<a href="https://cloud.google.com/identity-platform" target="_blank" rel="noopener noreferrer">Identity Platform</a>を選択しました。</p> <p>これは、</p> <ul> <li><strong>カンファレンスの参加者が使用するライブ配信サイト</strong></li> <li><strong>カンファレンスのオペレーションチームが利用する管理画面</strong></li> </ul> <p>があるためです。</p> <p>これをFirebase Authenticationで実現する場合、</p> <ul> <li>Firebase AuthenticationのCustom Claimを使用する</li> <li>Firebaseのプロジェクトを複数用意する</li> </ul> <p>という方法でも実現は可能かもしれません。</p> <p>しかし、「Firebase AuthenticationのCustom Claimを使用する」方法では、コンテキストが分離しておらず、カンファレンスの参加者のセッションで管理画面にはアクセスできないようにするなど、少々面倒なクライアント側の対応が必要です。 また、「Firebaseのプロジェクトを複数用意する」方法では、ライブ配信サイトが使用しているFirebase Realtime Databaseへ直接アクセスできないため、別途サーバーで処理する機構を用意する必要があります。</p> <p>Identity PlatformはFirebaseではなくGCPのサービスですが、Firebase Authenticationと互換性があり、SAMLやOIDCの認証方式やマルチテナント機能をサポートしています。</p> <p>そのため、開発においても、GCPのSDKではなく、FirebaseのSDKを使用します。</p> <p>このマルチテナント機能を使うことで、コンテキストを分けつつ、1つのプロジェクト内のFirebase Realtime Databaseを共有して使用できます。</p> <p><a href="/assets/posts/post/2021-10-29-1/identity_platform_diagram.png" data-fancybox="images" data-caption="Identity Plartformを使用した構成図"><img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Identity Plartformを使用した構成図" data-src="/assets/posts/post/2021-10-29-1/identity_platform_diagram.png" class="lazyload"></a></p> <h3 id="identity-platformのカスタムトークンの発行とカスタムクレームの設定">Identity Platformのカスタムトークンの発行とカスタムクレームの設定</h3> <p>今回はFirebaseを使っているため、Firebase for Cloud FunctionsをCallable HTTPS Functionとして使用してカスタムトークンを発行することにしました。</p> <p>以下はCallable HTTPS FunctionでIdentity Plartformを使用したカスタムトークンを発行する例です。</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">auth</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="kd">as </span><span class="nx">functions</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nf">region</span><span class="p">(</span><span class="dl">'</span><span class="s1">asia-northeast1</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">type</span> <span class="nx">IssueAdminPageCustomAuthTokenRequest</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">passCode</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">tenantAuth</span> <span class="o">=</span> <span class="nf">auth</span><span class="p">().</span><span class="nf">tenantManager</span><span class="p">().</span><span class="nf">authForTenant</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;ここにIdentity PlartformのテナントID&gt;</span><span class="dl">'</span><span class="p">);</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">issueAdminPageCustomAuthToken</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onCall</span><span class="p">(</span><span class="k">async </span><span class="p">({</span> <span class="nx">data</span> <span class="p">}:</span> <span class="nx">IssueAdminPageCustomAuthTokenRequest</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// 今回は 'PASSCODE' という文字と一致したらカスタムトークンを発行するようにする</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">passCode</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">PASSCODE</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nc">HttpsError</span><span class="p">(</span><span class="dl">'</span><span class="s1">permission-denied</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Passcode is invalid.</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">tenantAuth</span>
    <span class="p">.</span><span class="nf">createUser</span><span class="p">()</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error creating a user</span><span class="dl">'</span><span class="p">,</span> <span class="nx">e</span><span class="p">));</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nc">HttpsError</span><span class="p">(</span><span class="dl">'</span><span class="s1">aborted</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Faild to create a user.</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="p">[</span><span class="nx">token</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nf">all</span><span class="p">([</span>
    <span class="nx">tenantAuth</span>
      <span class="p">.</span><span class="nf">createCustomToken</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uid</span><span class="p">)</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error creating a custom token</span><span class="dl">'</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">user</span><span class="p">)),</span>
    <span class="cm">/**
     * セキュリティルールで使用するため、カスタムクレームを設定
     *
     * NOTE:
     *  テナントIDを設定することも考えたが、何かしらの理由でテナントIDを入れ替える可能性もあるため、
     *  それに引きづられてセキュリティルール側も変えるのはメンテナンス性が悪い
     *
     *  故に、'adminPage'という定数を使用している
     */</span>
    <span class="nx">tenantAuth</span><span class="p">.</span><span class="nf">setCustomUserClaims</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uid</span><span class="p">,</span> <span class="p">{</span> <span class="na">authContext</span><span class="p">:</span> <span class="dl">'</span><span class="s1">adminPage</span><span class="dl">'</span> <span class="p">}),</span>
  <span class="p">]);</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nc">HttpsError</span><span class="p">(</span><span class="dl">'</span><span class="s1">aborted</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Faild to create a token.</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span> <span class="nx">token</span> <span class="p">};</span>
<span class="p">});</span>
</code></pre></div></div> <p>今回の構成の場合、ブラウザから直接Firebase Realtime Databaseを参照しているため、セキュリティルールで管理画面のログインユーザー以外からはwriteを制限する必要があります。</p> <p>上記の例では、カスタムトークンを発行する以外に、<code class="language-plaintext highlighter-rouge">authContext</code>というカスタムクレームを追加していますが、この値をセキュリティルールで使用します。</p> <p>以下はFirebase Realtime Databaseのセキュリティルールの設定例です。</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"rules"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">".read"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">".write"</span><span class="p">:</span><span class="w"> </span><span class="s2">"auth !== null &amp;&amp; auth.token.authContext === 'adminPage'"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <h3 id="マルチテナントを有効化しているidentity-platformでの認証">マルチテナントを有効化しているIdentity Platformでの認証</h3> <p>マルチテナントを有効化しているIdentity Platformで認証する際は、クライアントコード側のFirebaseのAuthオブジェクトにテナントIDを設定することで、参照するテナントを切り替えられます。</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Firebase SDK v8</span>
<span class="k">import</span> <span class="nx">firebase</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">firebase</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">firebase/auth</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">firebase/functions</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nf">app</span><span class="p">().</span><span class="nf">functions</span><span class="p">(</span><span class="dl">'</span><span class="s1">asia-northeast1</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nf">auth</span><span class="p">();</span>
<span class="nx">auth</span><span class="p">.</span><span class="nx">tenantId</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&lt;ここにIdentity PlartformのテナントID&gt;</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">login</span> <span class="o">=</span> <span class="k">async </span><span class="p">(</span><span class="nx">passCode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">f</span><span class="p">.</span><span class="nf">httpsCallable</span><span class="p">(</span><span class="dl">'</span><span class="s1">issueAdminPageCustomAuthToken</span><span class="dl">'</span><span class="p">)({</span>
    <span class="nx">passCode</span><span class="p">,</span>
  <span class="p">});</span>
  <span class="kd">const</span> <span class="nx">signInResponse</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">auth</span><span class="p">.</span><span class="nf">signInWithCustomToken</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">signInResponse</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div> <h3 id="同一ソースコードでfirebase-sdkを使用する場合の工夫">同一ソースコードでFirebase SDKを使用する場合の工夫</h3> <p>ライブ配信サイトと管理画面はそれぞれ規模が小さいため、クライアントは同じソースコード上で実装されています。 そのため、同一ソースコードで複数のテナントを扱う必要がありました。</p> <p>同一コード内で複数のテナントを操作する場合、必ずFirebaseのアプリケーションの初期化時にアプリケーション名をつける必要があります。 Firebase Realtime Databaseなど、認証以外のアプリケーションを呼び出す際も、アプリケーション名を指定しないと、セキュリティルールで期待通りに認証情報が使用できないため、注意が必要です。</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Firebase SDK v8</span>
<span class="k">import</span> <span class="nx">firebase</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">firebase</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">firebase/auth</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">liveSiteTenantId</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">ここにIdentity Plartformのライブサイト用のテナントID</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">adminPageTenantId</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">ここにIdentity Plartformの管理画面用のテナントID</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Firebaseから取得した設定値を設定</span>
<span class="kd">const</span> <span class="nx">firebaseConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">apiKey</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xxxxxxxx</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">authDomain</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xxxxxxxx.firebaseapp.com</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">databaseURL</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://xxxxxxxx.&lt;region&gt;.firebasedatabase.app</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">projectId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xxxxxxxx</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storageBucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xxxxxxxx.appspot.com</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">messagingSenderId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xxxxxxxx</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">appId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xxxxxxxx</span><span class="dl">'</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**
 * NOTE:
 *  第二引数のアプリケーション名、テナントIDでなくてもよいが、都合が良いのでテナントIDを使用している
 *
 *  セキュリティルールと異なり、テナントIDが変わったら、コンテキストを変えることになるため、
 *  変わる可能性のあるテナントIDをアプリケーション名として使用しても問題ない
 */</span>
<span class="nx">firebase</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">(</span><span class="nx">firebaseConfig</span><span class="p">,</span> <span class="nx">liveSiteTenantId</span><span class="p">);</span>
<span class="nx">firebase</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">(</span><span class="nx">firebaseConfig</span><span class="p">,</span> <span class="nx">adminPageTenantId</span><span class="p">);</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">liveSiteApp</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">auth</span><span class="p">:</span> <span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nf">app</span><span class="p">(</span><span class="nx">liveSiteTenantId</span><span class="p">).</span><span class="nf">auth</span><span class="p">();</span>
    <span class="nx">auth</span><span class="p">.</span><span class="nx">tenantId</span> <span class="o">=</span> <span class="nx">liveSiteTenantId</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">auth</span><span class="p">;</span>
  <span class="p">})(),</span>
  <span class="na">database</span><span class="p">:</span> <span class="nx">firebase</span><span class="p">.</span><span class="nf">app</span><span class="p">(</span><span class="nx">liveSiteTenantId</span><span class="p">).</span><span class="nf">database</span><span class="p">(),</span>
<span class="p">};</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">adminPageApp</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">auth</span><span class="p">:</span> <span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nf">app</span><span class="p">(</span><span class="nx">adminPageTenantId</span><span class="p">).</span><span class="nf">auth</span><span class="p">();</span>
    <span class="nx">auth</span><span class="p">.</span><span class="nx">tenantId</span> <span class="o">=</span> <span class="nx">adminPageTenantId</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">auth</span><span class="p">;</span>
  <span class="p">})(),</span>
  <span class="na">database</span><span class="p">:</span> <span class="nx">firebase</span><span class="p">.</span><span class="nf">app</span><span class="p">(</span><span class="nx">adminPageTenantId</span><span class="p">).</span><span class="nf">database</span><span class="p">(),</span>
<span class="p">};</span>
</code></pre></div></div> <h2 id="開発環境と本番環境で異なる値を設定">開発環境と本番環境で異なる値を設定</h2> <p>Webサイトを構築する際、動作確認や品質保証のため、本番環境のほかに、開発環境や品質保証（QA）環境など、複数環境を用意することがあります。</p> <p>基本的には、それぞれの環境には本番環境と同じ内容をデプロイすることで、確認作業ができます。 理想的には差異がないことが望ましいですが、設定値など、どうしてもそれぞれの環境ごとに異なる値を使いたいことがあります。</p> <p>多くの場合、複数環境はそのためのインフラ環境を用意し、環境差異は<strong>環境変数</strong>で吸収します。</p> <p>Firebase（GCP）で複数環境を用意する場合は、Firebase（GCP）のプロジェクトを分けることが多いです。 ここまでは良いのですが、Firebase for Cloud Functionsを使用する場合、環境変数が使えないという問題があります。</p> <p>ワークアラウンドとしては、Firebase for Cloud Functionsの裏側はGCPであるため、<a href="https://cloud.google.com/functions/docs/configuring/env-var" target="_blank" rel="noopener noreferrer">GCPのAPI</a>でCloud Functionsをデプロイすることで環境変数を設定できます。 しかし、<a href="https://firebase.google.com/docs/functions/functions-and-firebase" target="_blank" rel="noopener noreferrer">Firebaseに最適化されたCloud Functions</a>として使用したい場合、一番初めはFirebase for Cloud Functionsとしてデプロイする必要があります。</p> <p>しかし、今回は、Firebaseの<a href="https://firebase.google.com/docs/functions/config-env" target="_blank" rel="noopener noreferrer">Runtime Configuration</a>を使うことにしました。</p> <p>理由としては、ワークアラウンドはデプロイのしくみを作る際に面倒であるため、できればFirebaseのしくみで実現したかったからです。 また、Runtime Configurationを使用することで、Firebaseのエミュレータ上にデプロイしたFirebase for Cloud Functionsでも値を参照できるメリットもあります。</p> <h3 id="runtime-configuration設定スクリプトの作成">Runtime Configuration設定スクリプトの作成</h3> <p>Runtime Configurationを設定する場合、キーには大文字やアンダースコア（<code class="language-plaintext highlighter-rouge">_</code>）などの記号が使えず、小文字しか設定できないという制約があります。</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npx firebase functions:config:set someservice.HOGE<span class="o">=</span><span class="s2">"HOGE"</span>

Error: Invalid config name someservice.HOGE, cannot use upper <span class="k">case</span><span class="nb">.</span>
</code></pre></div></div> <p>しかし、しばしば値をスネークケースやキャメルケースで設定したいことがあります。 実は、JSON文字列として値を設定する場合、この制約を受けずに済みます。</p> <p>JSONを処理するのは面倒である点、「Next.jsとFirebase for Cloud Functionsで共通の値を使用」で定義した値をシームレスに使用できる点から、Shell ScriptではなくTypeScriptで<code class="language-plaintext highlighter-rouge">firabase functions:config:set</code>コマンドをラップすることにしました。</p> <p>ちなみに、Firebase CLIは<a href="https://github.com/firebase/firebase-tools" target="_blank" rel="noopener noreferrer">firebase-tools</a>としてJavaScriptで実装されているため、わざわざCLIをラップせずにモジュールとして呼び出せば良いとも考えましたが、</p> <ul> <li>TypeScriptの型が提供されていない <ul> <li><a href="https://github.com/firebase/firebase-tools/issues/2378" target="_blank" rel="noopener noreferrer">https://github.com/firebase/firebase-tools/issues/2378</a></li> </ul> </li> <li>クレデンシャルやプロジェクト情報を別途取得する必要がある</li> </ul> <p>という理由から、Firebase CLIをラップすることにしました。</p> <p>また、このRuntime ConfigurationをFirebase エミュレータで使用する場合、functionsのルートディレクトリ（<code class="language-plaintext highlighter-rouge">firebase.json</code>の<code class="language-plaintext highlighter-rouge">functions.source</code>に設定しているディレクトリ）に<code class="language-plaintext highlighter-rouge">.runtimeconfig.json</code>を設置する必要があります。</p> <p>このあたりを吸収するため、簡単なスクリプトを作成することにしました。</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// functionConfig.ts</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getStageConfig</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@designship/stage-config</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="kd">as </span><span class="nx">child</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">child_process</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">promisify</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">util</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">execAsync</span> <span class="o">=</span> <span class="nf">promisify</span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">exec</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">CommandType</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">emulator</span><span class="p">:</span> <span class="dl">'</span><span class="s1">emulator</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">production</span><span class="p">:</span> <span class="dl">'</span><span class="s1">production</span><span class="dl">'</span><span class="p">,</span>
<span class="p">}</span> <span class="kd">as const</span><span class="p">;</span>
<span class="kd">type</span> <span class="nx">CommandType</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">CommandType</span><span class="p">[</span><span class="kr">keyof</span> <span class="k">typeof</span> <span class="nx">CommandType</span><span class="p">];</span>

<span class="kd">const</span> <span class="nx">parseCommand</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">?:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">CommandType</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">command</span> <span class="o">=</span> <span class="nx">s</span> <span class="kd">as </span><span class="nx">CommandType</span><span class="p">;</span>
  <span class="k">switch </span><span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">CommandType</span><span class="p">.</span><span class="na">emulator</span><span class="p">:</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">CommandType</span><span class="p">.</span><span class="nx">emulator</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="nx">CommandType</span><span class="p">.</span><span class="na">production</span><span class="p">:</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">CommandType</span><span class="p">.</span><span class="nx">production</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nl">default</span><span class="p">:</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="na">_unknownCommand</span><span class="p">:</span> <span class="nx">never</span> <span class="o">=</span> <span class="nx">command</span><span class="p">;</span>
      <span class="k">return</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="p">(</span><span class="k">async </span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">command</span> <span class="o">=</span> <span class="nf">parseCommand</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="s2">`The command required, </span><span class="p">${</span><span class="nb">Object</span><span class="p">.</span><span class="nf">values</span><span class="p">(</span><span class="nx">CommandType</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="s2">`'</span><span class="p">${</span><span class="nx">v</span><span class="p">}</span><span class="s2">'`</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1"> or </span><span class="dl">'</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">topLevelKey</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">stageconfig</span><span class="dl">'</span><span class="p">;</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">runtimeConfig</span> <span class="o">=</span> <span class="nf">getStageConfig</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STAGE</span> <span class="p">?</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STAGE</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">dev</span><span class="dl">'</span><span class="p">);</span>

    <span class="k">switch </span><span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">CommandType</span><span class="p">.</span><span class="na">emulator</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nf">fromEntries</span><span class="p">([[</span><span class="nx">topLevelKey</span><span class="p">,</span> <span class="nx">runtimeConfig</span><span class="p">]]),</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="nx">CommandType</span><span class="p">.</span><span class="na">production</span><span class="p">:</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">setCommand</span> <span class="o">=</span> <span class="s2">`firebase functions:config:set </span><span class="p">${</span><span class="nx">topLevelKey</span><span class="p">}</span><span class="s2">=</span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">runtimeConfig</span><span class="p">))}</span><span class="s2">`</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Running '</span><span class="p">${</span><span class="nx">setCommand</span><span class="p">}</span><span class="s2">' command....`</span><span class="p">);</span>
        <span class="k">await</span> <span class="nf">execAsync</span><span class="p">(</span><span class="nx">setCommand</span><span class="p">);</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="nl">default</span><span class="p">:</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="na">unknownCommand</span><span class="p">:</span> <span class="nx">never</span> <span class="o">=</span> <span class="nx">command</span><span class="p">;</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="s2">`The case for </span><span class="p">${</span><span class="nx">unknownCommand</span><span class="p">}</span><span class="s2"> is not described.`</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="k">throw</span> <span class="nx">e</span>
  <span class="p">}</span>
<span class="p">})().</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">process</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div> <p>このスクリプトは以下のように、用途によって使い分けられるようにしました。</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># emulator用のRuntime ConfigurationのJSONを標準出力として出力</span>
<span class="nv">$ STAGE</span><span class="o">=</span><span class="s1">'prod'</span> ts-node functionConfig.ts emulator <span class="o">&gt;</span> /path/to/function-source-directory/.runtimeconfig.json
<span class="c"># Cloud FunctionsにRuntime Configurationを設定</span>
<span class="nv">$ STAGE</span><span class="o">=</span><span class="s1">'prod'</span> ts-node functionConfig.ts production
</code></pre></div></div> <p>この処理のデメリットとしては、Runtime Configurationのキー名を変更した場合、値が残り続けてしまう点です。</p> <p>値を残さないために、差分を計算してRuntime Configurationをunsetできますが、</p> <ul> <li>デプロイ前にunsetすると、デプロイ間際でのユーザー影響が出る（無停止デプロイができない状態）</li> <li>デプロイ後にunsetすると、別プロセスでsetおよびunsetが実行されたりするケースなどを考慮する必要がある</li> </ul> <p>という問題があります。</p> <p>今回は短期間なプロジェクトであるため、トップレベルのキー（<code class="language-plaintext highlighter-rouge">stageconfig</code>）の変更はないと考え、unset処理は入れませんでした。</p> <p>ちなみに、<code class="language-plaintext highlighter-rouge">NODE_ENV</code>はNext.jsですでに使われていたため、余計な不具合を避けたいと考え、代わりに<code class="language-plaintext highlighter-rouge">STAGE</code>という環境変数を利用して、環境ごとの設定をするようにしました。</p> <h2 id="デプロイのしくみ">デプロイのしくみ</h2> <p>ライブ配信サイトはGitHubを使用して開発していました。 そのため、デプロイに関しては導入が容易なGitHub Actionsで行うことにしました。</p> <p>開発は、<code class="language-plaintext highlighter-rouge">main</code>リポジトリに対してPull Requsetを出して、CIとレビューが通ればマージするというスタイルを取っていました。 そのため、<code class="language-plaintext highlighter-rouge">main</code>リポジトリに変更があったら、自動で開発環境にデプロイし、開発版がいつでも確認できるようにしていました。</p> <p>さらに、本番環境に関しては、GitHub Actionsの<code class="language-plaintext highlighter-rouge">workflow_dispatch</code>機能を使用して、任意のタイミングでデプロイできるようにしました。</p> <p><a href="/assets/posts/post/2021-10-29-1/deploy_on_github_actions_by_workflow_dispatch.png" data-fancybox="images" data-caption="GitHub Actionsでのworkflow_dispatchでのデプロイ"><img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="GitHub Actionsでのworkflow_dispatchでのデプロイ" data-src="/assets/posts/post/2021-10-29-1/deploy_on_github_actions_by_workflow_dispatch.png" class="lazyload"></a></p> <h3 id="github-actionsと周辺ファイル設定">GitHub Actionsと周辺ファイル設定</h3> <p>具体的には以下のようにActionを定義しました。</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy</span>
<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">main</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">stage</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">support</span><span class="nv"> </span><span class="s">only</span><span class="nv"> </span><span class="s">"prod"</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">"dev"'</span>
        <span class="na">required</span><span class="pi">:</span> <span class="kc">true</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s1">'</span><span class="s">prod'</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup Node.js</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-node@v2</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">node-version</span><span class="pi">:</span> <span class="m">14</span>
          <span class="na">cache</span><span class="pi">:</span> <span class="s1">'</span><span class="s">npm'</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install Dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">npm ci</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to Firebase</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">npx firebase use "${STAGE}"</span>
          <span class="s">npm run deploy -- --force</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">FIREBASE_TOKEN</span><span class="pi">:</span> <span class="s">${{ github.event.inputs.stage == 'prod' &amp;&amp; secrets.FIREBASE_TOKEN_PROD || secrets.FIREBASE_TOKEN_DEV }}</span>
          <span class="na">STAGE</span><span class="pi">:</span> <span class="s">${{ github.event.inputs.stage == 'prod' &amp;&amp; 'prod' || 'dev' }}</span>
</code></pre></div></div> <p>step内のスクリプトが煩雑にならないように、Firebaseの環境の選択とnpm scriptsで用意したデプロイコマンドを実行するというシンプルな構成にしました。</p> <p><code class="language-plaintext highlighter-rouge">STAGE</code>変数の値でFirebaseのプロジェクトを選択できるようにするため、<code class="language-plaintext highlighter-rouge">.firebaserc</code>の<code class="language-plaintext highlighter-rouge">projects</code>のキーと対応するように設定しました。</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"projects"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dev"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sample-project-id-for-dev"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"prod"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sample-project-id-for-prod"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>また、参考程度ですがnpm scriptsは、以下のように設定しました。</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"functions:config"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"build"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"predeploy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"npm run build &amp;&amp; npm run functions:config -- production"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"deploy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"firebase deploy"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <h2 id="ハマったこと">ハマったこと</h2> <h3 id="callable-https-functionを使用するとcorsエラーとなる">Callable HTTPS Functionを使用するとCORSエラーとなる</h3> <p>初回デプロイ時に、動作確認をしていると、Callable HTTPS Functionを呼び出した際に、CORSエラーとなりました。 原因は、Cloud Functionsが任意のユーザーが呼び出せる様になっていなかったためです。</p> <p><a href="/assets/posts/post/2021-10-29-1/callable_https_function_non_allowed_all_users_at_gcp_console.png" data-fancybox="images" data-caption="Callable HTTPS Functionが呼び出しができない状態 at GCPコンソール"><img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Callable HTTPS Functionが呼び出しができない状態 at GCPコンソール" data-src="/assets/posts/post/2021-10-29-1/callable_https_function_non_allowed_all_users_at_gcp_console.png" class="lazyload"></a></p> <p>この問題は、<strong>Cloud Functions 起動元</strong>ロールに<strong>allUsers</strong>プリンシパルを設定した権限を、該当のCloud Functionsに付与することで解決しました。</p> <p><a href="/assets/posts/post/2021-10-29-1/callable_https_function_allowed_all_users_at_gcp_console.png" data-fancybox="images" data-caption="Callable HTTPS Functionが呼び出しができる状態 at GCPコンソール"><img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Callable HTTPS Functionが呼び出しができる状態 at GCPコンソール" data-src="/assets/posts/post/2021-10-29-1/callable_https_function_allowed_all_users_at_gcp_console.png" class="lazyload"></a></p> <p>しかし、別のProjectでは再現しなかったため、なぜ権限が付与されていなかったのかの原因まではわかりませんでした。 もしわかる方がいらっしゃいましたらご教示ください。</p> <h2 id="終わりに">終わりに</h2> <p>当日はライブ配信サイト自体は大きな問題もなく、無事2日間カンファレンスを開催できました。 もちろん、完璧ではなくいくつもの反省点がありましたが、それらは来年以降、改善したいと考えています。</p> <p>また、当日参加できなかった方は<a href="https://vimeo.com/ondemand/designship2021" target="_blank" rel="noopener noreferrer">アーカイブを販売</a>しているので、ぜひこの機会にご覧ください。</p> </article> <section class="share"> <a href="//twitter.com/share?text=Designship+2021%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E9%85%8D%E4%BF%A1%E3%82%B5%E3%82%A4%E3%83%88%E3%81%AE%E9%96%8B%E7%99%BA%E5%91%A8%E3%82%8A%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&amp;url=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2021-10-29-1%3Futm_source%3Dtwitter%26utm_medium%3Dsocial&amp;via=kenchan0130" onclick="window.open(this.href, 'twitter-share', 'width=550,height=255,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-twitter fa-lg"></i> </a> <a href="//www.facebook.com/sharer.php?t=Designship+2021%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E9%85%8D%E4%BF%A1%E3%82%B5%E3%82%A4%E3%83%88%E3%81%AE%E9%96%8B%E7%99%BA%E5%91%A8%E3%82%8A%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&amp;u=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2021-10-29-1%3Futm_source%3Dfacebook%26utm_medium%3Dsocial" onclick="window.open(this.href, 'facebook-share', 'width=550,height=255,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-facebook fa-lg"></i> </a> <a href="//b.hatena.ne.jp/entry/panel/?btitle=Designship+2021%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E9%85%8D%E4%BF%A1%E3%82%B5%E3%82%A4%E3%83%88%E3%81%AE%E9%96%8B%E7%99%BA%E5%91%A8%E3%82%8A%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&amp;url=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2021-10-29-1" onclick="window.open(this.href, 'hatena-share', 'width=550,height=600,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-hatena fa-lg"></i> </a> </section> <section class="post-donation"> <div class="post-donation-panel"> <p class="post-donation-description"> 参考になった・面白かったと感じていただけましたら、サポートいただけると励みになります。 </p> <a class="post-donation-button" href="https://www.buymeacoffee.com/kenchan0130" onclick="gtag('event', 'click-buymeacoffee', { event_category: 'www.buymeacoffee.com/kenchan0130', event_label: '/post/2021-10-29-1' });" target="_blank" rel="noopener noreferrer"> <p class="post-donation-button-body"> <img class="icon lazyload" alt="buymeacoffee" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg"> <span class="label">サポートする</span> </p> </a> </div> </section> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2444060431947599" data-ad-slot="7319689305" data-ad-format="auto"></ins> <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script> <section class="sub-contents related-posts"> <div class="sub-contents-wrapper"> <div class="sub-contents-title">あわせて読みたい</div> <div class="sub-contents-main"> <li> <a href="/post/2020-10-21-1">Cloud Functions for Firebaseを使用した時に、Cloud Storageのストレージ容量が圧迫される問題について調べた</a> <span class="post-date">- October 21, 2020</span> </li> <li> <a href="/post/2021-02-24-1">GitHub ActionsのRunner OSの情報を取得できるアクションを作った</a> <span class="post-date">- February 24, 2021</span> </li> <li> <a href="/post/2019-12-25-1">Google Apps Scriptのモダンな開発環境は理想だった</a> <span class="post-date">- December 25, 2019</span> </li> <li> <a href="/post/2018-12-03-1">Google Apps Scriptのモダンな開発環境を求めて</a> <span class="post-date">- December 3, 2018</span> </li> <li> <a href="/post/2021-12-09-1">Next.jsでStatic GenerationしたサイトをAWSでホスティングする</a> <span class="post-date">- December 9, 2021</span> </li> </div> </div> </section> <section class="sub-contents tags"> <div class="sub-contents-wrapper"> <div class="sub-contents-title">Tags</div> <div class="sub-contents-main"> <a href="/tag/firebase">Firebase</a> <a href="/tag/gcp">GCP</a> <a href="/tag/github">GitHub</a> <a href="/tag/node-js">Node.js</a> <a href="/tag/typescript">TypeScript</a> </div> </div> </section> </div> </div> </div> <footer class="site-footer"> <div class="wrapper"> <h3 class="footer-heading">kenchan0130 blog</h3> <div class="site-navigation"> <p><strong>Site Map</strong></p> <ul class="pages"> <li class="nav-link"> <a href="/archives">Archives</a> </li> <li class="nav-link"> <a href="/privacy">Privacy Policy</a> </li> <li class="nav-link"> <a href="/profile">Profile</a> </li> <li class="nav-link"> <a href="/profile/resume">Resume</a> </li> </ul> </div> <div class="site-contact"> <p><strong>Contact</strong></p> <ul class="social-media-list"> <li> <a href="https://twitter.com/kenchan0130" title="Follow me on Twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> <span class="username">kenchan0130</span> </a> </li> <li> <a href="https://github.com/kenchan0130" title="Fork me on GitHub" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> <span class="username">kenchan0130</span> </a> </li> </ul> </div> <div class="site-signature"> <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p> <p class="text">ソフトウェアエンジニア。記録に残したいことを雑に備忘するブログ。 投稿内容は個人の見解であり所属する組織の公式見解ではありません。 </p> </div> </div> <div class="licence">このサイトのコンテンツは<a href="https://creativecommons.org/licenses/by/4.0/deed.ja" target="_blank" rel="noopener noreferrer">Creative Commons Attribution 4.0 International (CC-BY-4.0) License</a>の下でライセンスされています。</div> <div class="copyright">Copyright © 2017-2025 Tadayuki Onishi All Rights Reserved.</div> </footer> <script src="/assets/bundle/app.6b4bd929e0a1773ddf90.js" async></script> <script async src="//www.googletagmanager.com/gtag/js?id=G-B7RX34Q5PL"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-B7RX34Q5PL");</script> <script async src="//www.googletagmanager.com/gtag/js?id=UA-79827366-2"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-79827366-2");</script> </body> </html>