<!DOCTYPE html> <html> <!-- This page is used centrarium Jekyll theme Copyright (c) 2015 Ben Centra Released under the MIT license https://github.com/bencentra/centrarium/blob/daa0d16ba9156ad43f9980e2075023a0d48859a5/LICENSE.md --> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"> <title>Jekyllの画像遅延ロードのためのライブラリを作った</title> <meta name="description" content="JekyllはRubyGemsで配布されているRuby製の静的サイト生成ツールです。 このブログもJekyllを使用しています。 そのJekyllでの使用を想定した画像の遅延ロードためのgemを作成したので、使い方を備忘として記載します。"> <meta name="author" content="Tadayuki Onishi"> <meta name="copyright" content="© Tadayuki Onishi 2025"> <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon"> <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon"> <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png"> <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png"> <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png"> <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png"> <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png"> <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png"> <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/android-icon-192x192.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png"> <link rel="manifest" href="/assets/icons/manifest.json"> <meta name="msapplication-TileColor" content="#ffffff"> <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png"> <meta name="theme-color" content="#ffffff"> <meta property="fb:app_id" content="376889769419405"> <meta property="og:description" content="JekyllはRubyGemsで配布されているRuby製の静的サイト生成ツールです。 このブログもJekyllを使用しています。 そのJekyllでの使用を想定した画像の遅延ロードためのgemを作成したので、使い方を備忘として記載します。"> <meta property="og:url" content="https://kenchan0130.github.io/post/2018-07-30-1"> <meta property="og:site_name" content="kenchan0130 blog"> <meta property="og:title" content="Jekyllの画像遅延ロードのためのライブラリを作った"> <meta property="og:type" content="website"> <meta property="og:author" content="Tadayuki Onishi"> <meta property="og:image" content="https://kenchan0130.github.io/assets/logo.png"> <meta property="og:image:width" content="760"> <meta property="og:image:height" content="760"> <meta property="og:image:type" content="image/png"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="Jekyllの画像遅延ロードのためのライブラリを作った"> <meta name="twitter:site" content="@kenchan0130"> <meta name="twitter:description" content="JekyllはRubyGemsで配布されているRuby製の静的サイト生成ツールです。 このブログもJekyllを使用しています。 そのJekyllでの使用を想定した画像の遅延ロードためのgemを作成したので、使い方を備忘として記載します。"> <meta name="twitter:image" content="https://kenchan0130.github.io/assets/logo.png"> <meta name="twitter:url" content="https://kenchan0130.github.io/post/2018-07-30-1"> <link rel="preload" as="style" href="/assets/bundle/app.6b4bd929e0a1773ddf90.css" onload="this.onload=null;this.rel='stylesheet'"> <noscript> <link rel="stylesheet" href="/assets/bundle/app.6b4bd929e0a1773ddf90.css"> </noscript> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="https://kenchan0130.github.io/post/2018-07-30-1"> <link rel="alternate" type="application/atom+xml" title="kenchan0130 blog" href="https://kenchan0130.github.io/feed.xml"> <meta name="google-site-verification" content="ZxlKORgZZwZ4TTmaQJFFEXLF3jmd6P_NVU9TEVW1bSg"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> </head> <body> <header class="navigation" role="banner"> <div class="navigation-wrapper"> <a href="/" class="logo"> <img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="kenchan0130 blog" data-src="/assets/logo.png" class="lazyload"> </a> <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu"> <i class="fas fa-bars"></i> </a> <nav role="navigation"> <ul id="js-navigation-menu" class="navigation-menu"> <li class="nav-search-box"> <div class="search-input-container"> <input type="search" class="search-input" id="js-search-input" placeholder="Search" autocomplete="off" onfocus="gtag('event', 'search', { event_category: 'www.algolia.com/apps/DEFR5IK9E2/explorer/browse/kenchan0130_blog', event_label: '/post/2018-07-30-1' });"> <i class="fa fa-search search-input-icon"></i> <template id="suggestion-template"> <a href="" onclick="gtag('event', 'click', { event_category: 'www.algolia.com/apps/DEFR5IK9E2/explorer/browse/kenchan0130_blog', event_label: this.href });"> <p class="suggestion-title js-suggestion-title"></p> <p class="suggestion-content js-suggestion-content"></p> </a> </template> </div> </li> <li class="nav-link"> <a href="/archives">Archives</a> </li> <li class="nav-link"> <a href="/profile">Profile</a> </li> </ul> </nav> </div> </header> <div class="page-content"> <div class="post"> <div class="post-header-container "> <div class="scrim "> <header class="post-header"> <h1 class="title">Jekyllの画像遅延ロードのためのライブラリを作った</h1> </header> </div> </div> <div class="wrapper"> <span class="page-divider"> <span class="one"></span> <span class="two"></span> </span> <section class="post-meta"> <div class="post-date">2018-07-30</div> <div class="post-categories"> <i class="fas fa-fw fa-book"></i> <a href="/category/development">development </a> </div> </section> <article class="post-content"> <p><a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> は <a href="https://rubygems.org/" target="_blank" rel="noopener noreferrer">RubyGems</a> で配布されているRuby製の静的サイト生成ツールです。 このブログもJekyllを使用しています。</p> <p>Jekyllでの使用を想定した画像の遅延ロードため <a href="https://github.com/kenchan0130/jekyll-lazy-load-image" target="_blank" rel="noopener noreferrer"><code class="language-plaintext highlighter-rouge">jekyll-lazy-load-image</code></a> というRubyGemsを作成しました。</p> <p>今回は作成の意図とその使い方などを備忘として記載していこうと思います。</p> <ul id="markdown-toc"> <li> <a href="#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E4%BD%9C%E6%88%90%E3%81%AE%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" id="markdown-toc-ライブラリ作成のモチベーション">ライブラリ作成のモチベーション</a> <ul> <li><a href="#%E9%87%8D%E3%81%84%E7%94%BB%E5%83%8F%E3%81%8C%E3%81%82%E3%82%8B%E3%81%A8%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%8C%E9%81%85%E3%81%84" id="markdown-toc-重い画像があるとレンダリングが遅い">重い画像があるとレンダリングが遅い</a></li> <li><a href="#rubygems%E3%81%AB%E5%88%87%E3%82%8A%E5%87%BA%E3%81%99%E3%81%A8%E3%81%84%E3%81%86%E9%81%B8%E6%8A%9E" id="markdown-toc-rubygemsに切り出すという選択">RubyGemsに切り出すという選択</a></li> </ul> </li> <li> <a href="#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E4%BD%9C%E6%88%90%E6%96%B9%E9%87%9D" id="markdown-toc-ライブラリの作成方針">ライブラリの作成方針</a> <ul> <li><a href="#jekyll%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E7%94%BB%E5%83%8F%E9%9D%9E%E5%90%8C%E6%9C%9F%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E3%81%AE%E8%AA%B2%E9%A1%8C" id="markdown-toc-jekyllにおける画像非同期読み込みの課題">Jekyllにおける画像非同期読み込みの課題</a></li> <li><a href="#jekyll%E3%81%AE%E6%8B%A1%E5%BC%B5%E3%81%AE%E9%81%B8%E6%8A%9E" id="markdown-toc-jekyllの拡張の選択">Jekyllの拡張の選択</a></li> <li><a href="#%E4%BE%9D%E5%AD%98%E3%81%AE%E6%9C%80%E5%B0%8F%E5%8C%96" id="markdown-toc-依存の最小化">依存の最小化</a></li> <li><a href="#%E8%A8%AD%E5%AE%9A%E9%A0%85%E7%9B%AE%E3%81%AE%E6%9C%80%E5%B0%8F%E5%8C%96" id="markdown-toc-設定項目の最小化">設定項目の最小化</a></li> <li><a href="#%E5%80%8B%E5%88%A5%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%B8%E3%81%AE%E5%AF%BE%E5%BF%9C" id="markdown-toc-個別呼び出しへの対応">個別呼び出しへの対応</a></li> </ul> </li> <li> <a href="#jekyll-lazy-load-image%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9" id="markdown-toc-jekyll-lazy-load-imageの使い方">jekyll-lazy-load-imageの使い方</a> <ul> <li><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA%E3%81%9B%E3%81%9A%E3%81%AB%E5%8B%95%E3%81%8B%E3%81%99" id="markdown-toc-カスタマイズせずに動かす">カスタマイズせずに動かす</a></li> <li><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA%E3%81%97%E3%81%A6%E5%8B%95%E3%81%8B%E3%81%99" id="markdown-toc-カスタマイズして動かす">カスタマイズして動かす</a></li> </ul> </li> <li><a href="#%E3%81%BE%E3%81%A8%E3%82%81" id="markdown-toc-まとめ">まとめ</a></li> </ul> <h2 id="ライブラリ作成のモチベーション">ライブラリ作成のモチベーション</h2> <h3 id="重い画像があるとレンダリングが遅い">重い画像があるとレンダリングが遅い</h3> <p>通常、ブラウザにおけるHTMLのページレンダリング時の画像の読み込みは、 レンダリングをブロック、つまり同期的に行います。</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="na">src=</span><span class="s">"path/to/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"path/to/css"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"path/to/image"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div> <p>上記のHTMLがブラウザでレンダリングされる場合、</p> <ol> <li>HTMLをリクエスト</li> <li>HTMLの取得</li> <li>HTMLのDOM生成 <ol> <li> <code class="language-plaintext highlighter-rouge">path/to/javascript</code> のJavaScriptをリクエスト</li> <li> <code class="language-plaintext highlighter-rouge">path/to/css</code> のCSSをリクエスト</li> <li> <code class="language-plaintext highlighter-rouge">path/to/image</code> の画像をリクエスト</li> </ol> </li> <li>ページレンダリング完了</li> </ol> <p>という挙動をします。</p> <p>もし <code class="language-plaintext highlighter-rouge">path/to/image</code> が重いファイルだった場合、「ページレンダリング完了」までに時間がかかってしまいます。</p> <p>1つの解決方法として <code class="language-plaintext highlighter-rouge">img</code> タグの <code class="language-plaintext highlighter-rouge">src</code> 属性にダミー画像やロード中の画像を指定しつつ、 JavaScriptを使用して画像を非同期で読み込むことでページレンダリングをブロックしないようにできます。</p> <p>たまたまこのブログで少々重めのgifを表示したいことがあり、体感的にレンダリングが遅かったため、非同期で画像を読み込みたいと考えました。</p> <h3 id="rubygemsに切り出すという選択">RubyGemsに切り出すという選択</h3> <p>Jekyllのプロジェクトでは <code class="language-plaintext highlighter-rouge">_plugins</code> ディレクトリにファイルを設置することで、 自作のJekyll Pluginを作成および導入が可能です。</p> <p>しかし、 <code class="language-plaintext highlighter-rouge">_plugins</code> に設置する自作のJekyll Pluginは、中々テストが書かれることがありません。</p> <p>RubyGemsに切り出せば、テストを記載するだろうと思い、切り出すことにしました。</p> <h2 id="ライブラリの作成方針">ライブラリの作成方針</h2> <p><code class="language-plaintext highlighter-rouge">jekyll-lazy-load-image</code> を作成する際に、以下のようなことを気にして作成しました。</p> <h3 id="jekyllにおける画像非同期読み込みの課題">Jekyllにおける画像非同期読み込みの課題</h3> <p>JekyllではしばしばHTMLをそのまま記載するのではなくMarkdownなど別のファイルフォーマットで記載されたドキュメントを使用して静的サイトを生成します。 そのため、HTML以外のファイルフォーマットで記載されたドキュメントをJekyllのコンバーターでの処理が終わった後に <code class="language-plaintext highlighter-rouge">img</code> タグを変更する必要があります。</p> <h3 id="jekyllの拡張の選択">Jekyllの拡張の選択</h3> <p>Jekyllには拡張をするための機構が</p> <ul> <li><a href="https://jekyllrb.com/docs/plugins/#generators" target="_blank" rel="noopener noreferrer">Generators</a></li> <li><a href="https://jekyllrb.com/docs/plugins/#converters" target="_blank" rel="noopener noreferrer">Converters</a></li> <li><a href="https://jekyllrb.com/docs/plugins/#commands" target="_blank" rel="noopener noreferrer">Commands</a></li> <li><a href="https://jekyllrb.com/docs/plugins/#tags" target="_blank" rel="noopener noreferrer">Tags</a></li> <li><a href="https://jekyllrb.com/docs/plugins/#hooks" target="_blank" rel="noopener noreferrer">Hooks</a></li> </ul> <p>の5つ用意されています。</p> <p>今回はJekyllのコンバーターの処理が終わったドキュメントに対して変更したいため、「Hooks」を使用します。</p> <p>Hooksにはドキュメントをレンダリングした後、静的HTMLを出力する前に呼び出される <code class="language-plaintext highlighter-rouge">:post_render</code> があります。 こちらを使用して生成されたHTMLを変更する方法を選択しました。</p> <h3 id="依存の最小化">依存の最小化</h3> <p>RubyGemsを作成する際には、依存するライブラリを選択できます。 今回はなるべく軽量で汎用性が高いように作成したかったため、依存するライブラリを極力少なくすることにしました。</p> <p>よくやりがちな、とりあえず <a href="https://github.com/rails/rails/tree/master/activesupport" target="_blank" rel="noopener noreferrer">ActiveSupport</a> を入れるみたいなことを避けて、本当に必要なライブラリだけを利用することにしました。</p> <p>もちろん、ActiveSupoortはとても便利です。 よく使われるメソッドや拡張が数多く用意されていて、かつテストが書かれているというのはとても魅力的です。</p> <p>今回はHTMLの編集とJekyllのHooksを使用するため、</p> <ul> <li> <a href="https://github.com/sparklemotion/nokogiri" target="_blank" rel="noopener noreferrer">Nokogiri</a> <ul> <li>HTMLの編集</li> </ul> </li> <li> <a href="https://github.com/jekyll/jekyll" target="_blank" rel="noopener noreferrer">Jekyll</a> <ul> <li>JekyllのHooksの呼び出し</li> </ul> </li> </ul> <p>の2つのみを依存に含めました。</p> <h3 id="設定項目の最小化">設定項目の最小化</h3> <p>RubyGemsへ切り出したため、さまざまなユーザーを想定しました。 特にJekyllを使用しているサイトの作成者は、JekyllやRubyに詳しい人ばかりとは限りません。 細かい設定などは逆に使用者に負担をかける可能性があります。</p> <p>そのため、最低限動作するに設計しました。 具体的には <code class="language-plaintext highlighter-rouge">_config.yml</code> と <code class="language-plaintext highlighter-rouge">Gemfile</code> の変更と使用するJavaScriptの追加のみで動作するようにしました。</p> <h4 id="遅延ロードのjavascriptの処遇">遅延ロードのJavaScriptの処遇</h4> <p>細かい設定を少なくすると言ったわりには、 <code class="language-plaintext highlighter-rouge">jekyll-lazy-load-image</code> では遅延ロードのJavaScriptを使用者で設定してもらうようにしています。</p> <p>JekyllのTags拡張を使用することで、遅延ロードのJavaScriptの呼び出しを簡略化することも検討しました。 しかし、ことJavaScriptに関してはサイトに寄って呼び出し方法がまちまちであるため、むやみに呼び出しを強制してしまうのは逆にライブラリとして使用されづらくなると考え、このような形にすることにしました。</p> <h3 id="個別呼び出しへの対応">個別呼び出しへの対応</h3> <p>設定項目を最小化することで、 JekyllやRubyに詳しくない方でもすぐに効果が現れるようにしました。</p> <p>もちろんJekyllやRubyに詳しい方もいるため、その人達用にメソッドを個別に呼び出せるようにしてカスタマイズできるようにしようと考えました。</p> <p>メインとなる <code class="language-plaintext highlighter-rouge">img</code> タグの <code class="language-plaintext highlighter-rouge">src</code> 属性の変更に関しては個別でも呼び出せるように設計をしました。 しかし、まだ不十分な部分もあるため、 <a href="https://github.com/kenchan0130/jekyll-lazy-load-image/issues/1" target="_blank" rel="noopener noreferrer">Issue</a> としてタスクに積み、改善を予定しています。</p> <h2 id="jekyll-lazy-load-imageの使い方">jekyll-lazy-load-imageの使い方</h2> <h3 id="カスタマイズせずに動かす">カスタマイズせずに動かす</h3> <h4 id="gemfile-の設定"> <code class="language-plaintext highlighter-rouge">Gemfile</code> の設定</h4> <p>Jekyllのプロジェクトの <code class="language-plaintext highlighter-rouge">Gemfile</code> に以下を追加します。</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">group</span> <span class="ss">:jekyll_plugins</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'jekyll-lazy-load-image'</span><span class="p">,</span> <span class="ss">require: </span><span class="s1">'jekyll-lazy-load-image/auto-execution'</span>
<span class="k">end</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">gem 'jekyll-lazy-load-image'</code> のみでは拡張用に処理は走らないようになっており、 <code class="language-plaintext highlighter-rouge">require: 'jekyll-lazy-load-image/auto-execution'</code> を付与することで、自動で処理が走ります。</p> <h4 id="遅延ロードのライブラリの設定">遅延ロードのライブラリの設定</h4> <p>遅延ロードライブラリはお好きなものを使用してかまいませんが、</p> <ul> <li><a href="https://github.com/aFarkas/lazysizes" target="_blank" rel="noopener noreferrer">lazysizes</a></li> <li><a href="https://github.com/toddmotto/echo" target="_blank" rel="noopener noreferrer">Echo.js</a></li> <li><a href="https://github.com/fallroot/tada" target="_blank" rel="noopener noreferrer">TADA</a></li> </ul> <p>あたりが良いかもしれません。</p> <p>Jekyllのプロジェクトのアセットに追加ソースを追加する、またはCDNを指定を読み込むなどを行い、遅延ロードライブラリを読み込ませます。</p> <p>例としてlazysizesをCDNで読み込ませる場合は、テンプレートの任意の場所に</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"//cdnjs.cloudflare.com/ajax/libs/lazysizes/4.0.4/lazysizes.min.js"</span> <span class="na">async</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div> <p>を追加すれば完了です。</p> <h4 id="_configymlの設定">_config.ymlの設定</h4> <p>Jekyllのプロジェクトの <code class="language-plaintext highlighter-rouge">_config.yml</code> に、このライブラリで使用する設定を以下のように記載します。</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">lazy_load_image</span><span class="pi">:</span>
  <span class="na">src_attr_name</span><span class="pi">:</span> <span class="s">data-src</span>
  <span class="na">preload_image</span><span class="pi">:</span> <span class="s">/path/to/image</span>
  <span class="na">class_attr_values</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">lazyload</span>
  <span class="na">ignore_selectors</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">.ignore-lazy-image-load"</span>
  <span class="na">additional_attrs</span><span class="pi">:</span>
    <span class="s2">"</span><span class="s">data-size"</span><span class="err">:</span> <span class="s">auto</span>
</code></pre></div></div> <p>各設定の内容は以下です。使用する遅延ロードライブラリに合わせて設定してください。</p> <table> <thead> <tr> <th style="text-align: center">設定名</th> <th style="text-align: center">必須</th> <th style="text-align: left">内容</th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><code class="language-plaintext highlighter-rouge">src_attr_name</code></td> <td style="text-align: center">required</td> <td style="text-align: left"> <code class="language-plaintext highlighter-rouge">img</code> タグの <code class="language-plaintext highlighter-rouge">src</code> 属性の代わりに設定する属性名</td> </tr> <tr> <td style="text-align: center"><code class="language-plaintext highlighter-rouge">preload_image</code></td> <td style="text-align: center">optional</td> <td style="text-align: left">画像のロードが終わるまでに表示させる内容、つまり <code class="language-plaintext highlighter-rouge">img</code> タグの <code class="language-plaintext highlighter-rouge">src</code> 属性にデフォルトで設定する内容</td> </tr> <tr> <td style="text-align: center"><code class="language-plaintext highlighter-rouge">class_attr_values</code></td> <td style="text-align: center">optional</td> <td style="text-align: left"> <code class="language-plaintext highlighter-rouge">img</code> タグの <code class="language-plaintext highlighter-rouge">class</code> 属性に追加で付与する値（複数指定可能）</td> </tr> <tr> <td style="text-align: center"><code class="language-plaintext highlighter-rouge">ignore_selectors</code></td> <td style="text-align: center">optional</td> <td style="text-align: left">処理を除外する対象のセレクタ（cssまたはxpathで複数指定可能）</td> </tr> <tr> <td style="text-align: center"><code class="language-plaintext highlighter-rouge">additional_attrs</code></td> <td style="text-align: center">optional</td> <td style="text-align: left">追加で <code class="language-plaintext highlighter-rouge">img</code> タグに設定したい属性名と値の組み合わせ</td> </tr> </tbody> </table> <h3 id="カスタマイズして動かす">カスタマイズして動かす</h3> <p>処理を実行するタイミングやコンテナの種類を変えることができます。 遅延ロードライブラリの設定は共通であるため省略します。</p> <h4 id="gemfileの設定">Gemfileの設定</h4> <p>Jekyllのプロジェクトの <code class="language-plaintext highlighter-rouge">Gemfile</code> に以下を追加します。</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'jekyll-lazy-load-image'</span>
</code></pre></div></div> <h4 id="_pluginsディレクトリへファイルの追加">_pluginsディレクトリへファイルの追加</h4> <p>ドキュメントに対して処理を行いたいとした場合は、 <code class="language-plaintext highlighter-rouge">_plugins</code> ディレクトリに</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'jekyll-lazy-load-image'</span>

<span class="no">JekyllLazyLoadImage</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">owners</span> <span class="o">=</span> <span class="ss">:documents</span>
<span class="k">end</span>

<span class="no">JekyllLazyLoadImage</span><span class="p">.</span><span class="nf">execute</span>
</code></pre></div></div> <p>上記のようなファイルを任意の名前で追加することで実現できます。</p> <h2 id="まとめ">まとめ</h2> <p>今回はJekyllで作成するサイトに対して画像を遅延ロードの設定を施すライブラリの作成についてと、その使い方について記載しました。 少しでも同じ課題を持っている方の助けになれば幸いです。</p> <p>また、今回作成した <a href="https://github.com/kenchan0130/jekyll-lazy-load-image" target="_blank" rel="noopener noreferrer"><code class="language-plaintext highlighter-rouge">jekyll-lazy-load-image</code></a> は、ある程度考えて設計したものの、実際使用してみると使いづらい点などがあるかと思います。 OSSとして公開しているので、ぜひ <a href="https://github.com/kenchan0130/jekyll-lazy-load-image/issues" target="_blank" rel="noopener noreferrer">Issue</a> 、 <a href="https://github.com/kenchan0130/jekyll-lazy-load-image/pulls" target="_blank" rel="noopener noreferrer">Pull Request</a> いただければと思います。</p> </article> <section class="share"> <a href="//twitter.com/share?text=Jekyll%E3%81%AE%E7%94%BB%E5%83%8F%E9%81%85%E5%BB%B6%E3%83%AD%E3%83%BC%E3%83%89%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%9F&amp;url=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2018-07-30-1%3Futm_source%3Dtwitter%26utm_medium%3Dsocial&amp;via=kenchan0130" onclick="window.open(this.href, 'twitter-share', 'width=550,height=255,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-twitter fa-lg"></i> </a> <a href="//www.facebook.com/sharer.php?t=Jekyll%E3%81%AE%E7%94%BB%E5%83%8F%E9%81%85%E5%BB%B6%E3%83%AD%E3%83%BC%E3%83%89%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%9F&amp;u=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2018-07-30-1%3Futm_source%3Dfacebook%26utm_medium%3Dsocial" onclick="window.open(this.href, 'facebook-share', 'width=550,height=255,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-facebook fa-lg"></i> </a> <a href="//b.hatena.ne.jp/entry/panel/?btitle=Jekyll%E3%81%AE%E7%94%BB%E5%83%8F%E9%81%85%E5%BB%B6%E3%83%AD%E3%83%BC%E3%83%89%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%9F&amp;url=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2018-07-30-1" onclick="window.open(this.href, 'hatena-share', 'width=550,height=600,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-hatena fa-lg"></i> </a> </section> <section class="post-donation"> <div class="post-donation-panel"> <p class="post-donation-description"> 参考になった・面白かったと感じていただけましたら、サポートいただけると励みになります。 </p> <a class="post-donation-button" href="https://www.buymeacoffee.com/kenchan0130" onclick="gtag('event', 'click-buymeacoffee', { event_category: 'www.buymeacoffee.com/kenchan0130', event_label: '/post/2018-07-30-1' });" target="_blank" rel="noopener noreferrer"> <p class="post-donation-button-body"> <img class="icon lazyload" alt="buymeacoffee" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg"> <span class="label">サポートする</span> </p> </a> </div> </section> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2444060431947599" data-ad-slot="7319689305" data-ad-format="auto"></ins> <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script> <section class="sub-contents related-posts"> <div class="sub-contents-wrapper"> <div class="sub-contents-title">あわせて読みたい</div> <div class="sub-contents-main"> <li> <a href="/post/2020-07-17-1">RailsでJSONのリクエストパラメータがパースできなかった場合の対応</a> <span class="post-date">- July 17, 2020</span> </li> <li> <a href="/post/2020-07-07-1">Rails 5アップグレードへの道</a> <span class="post-date">- July 7, 2020</span> </li> </div> </div> </section> <section class="sub-contents tags"> <div class="sub-contents-wrapper"> <div class="sub-contents-title">Tags</div> <div class="sub-contents-main"> <a href="/tag/jekyll">Jekyll</a> <a href="/tag/ruby">Ruby</a> <a href="/tag/rubygems">RubyGems</a> </div> </div> </section> </div> </div> </div> <footer class="site-footer"> <div class="wrapper"> <h3 class="footer-heading">kenchan0130 blog</h3> <div class="site-navigation"> <p><strong>Site Map</strong></p> <ul class="pages"> <li class="nav-link"> <a href="/archives">Archives</a> </li> <li class="nav-link"> <a href="/privacy">Privacy Policy</a> </li> <li class="nav-link"> <a href="/profile">Profile</a> </li> <li class="nav-link"> <a href="/profile/resume">Resume</a> </li> </ul> </div> <div class="site-contact"> <p><strong>Contact</strong></p> <ul class="social-media-list"> <li> <a href="https://twitter.com/kenchan0130" title="Follow me on Twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> <span class="username">kenchan0130</span> </a> </li> <li> <a href="https://github.com/kenchan0130" title="Fork me on GitHub" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> <span class="username">kenchan0130</span> </a> </li> </ul> </div> <div class="site-signature"> <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p> <p class="text">ソフトウェアエンジニア。記録に残したいことを雑に備忘するブログ。 投稿内容は個人の見解であり所属する組織の公式見解ではありません。 </p> </div> </div> <div class="licence">このサイトのコンテンツは<a href="https://creativecommons.org/licenses/by/4.0/deed.ja" target="_blank" rel="noopener noreferrer">Creative Commons Attribution 4.0 International (CC-BY-4.0) License</a>の下でライセンスされています。</div> <div class="copyright">Copyright © 2017-2025 Tadayuki Onishi All Rights Reserved.</div> </footer> <script src="/assets/bundle/app.6b4bd929e0a1773ddf90.js" async></script> <script async src="//www.googletagmanager.com/gtag/js?id=G-B7RX34Q5PL"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-B7RX34Q5PL");</script> <script async src="//www.googletagmanager.com/gtag/js?id=UA-79827366-2"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-79827366-2");</script> </body> </html>