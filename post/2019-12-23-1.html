<!DOCTYPE html> <html> <!-- This page is used centrarium Jekyll theme Copyright (c) 2015 Ben Centra Released under the MIT license https://github.com/bencentra/centrarium/blob/daa0d16ba9156ad43f9980e2075023a0d48859a5/LICENSE.md --> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"> <title>Spring Security SAMLでSpring BootアプリをSAML対応</title> <meta name="description" content="Spring SecurityはSpring Bootアプリケーションの認証と認可を設定可能なフレームワークです。 標準のSpring SecurityにはOAuth2がサポートされていますがSAMLはサポートされていません。 しかし、公式がSpring SecurityのSAML Extensionを提供しており比較的容易にSAMLをサポートできます。 今回はSpring SecurityでSAML対応する方法を紹介します。"> <meta name="author" content="Tadayuki Onishi"> <meta name="copyright" content="© Tadayuki Onishi 2025"> <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon"> <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon"> <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png"> <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png"> <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png"> <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png"> <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png"> <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png"> <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/android-icon-192x192.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png"> <link rel="manifest" href="/assets/icons/manifest.json"> <meta name="msapplication-TileColor" content="#ffffff"> <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png"> <meta name="theme-color" content="#ffffff"> <meta property="fb:app_id" content="376889769419405"> <meta property="og:description" content="Spring SecurityはSpring Bootアプリケーションの認証と認可を設定可能なフレームワークです。 標準のSpring SecurityにはOAuth2がサポートされていますがSAMLはサポートされていません。 しかし、公式がSpring SecurityのSAML Extensionを提供しており比較的容易にSAMLをサポートできます。 今回はSpring SecurityでSAML対応する方法を紹介します。"> <meta property="og:url" content="https://kenchan0130.github.io/post/2019-12-23-1"> <meta property="og:site_name" content="kenchan0130 blog"> <meta property="og:title" content="Spring Security SAMLでSpring BootアプリをSAML対応"> <meta property="og:type" content="website"> <meta property="og:author" content="Tadayuki Onishi"> <meta property="og:image" content="https://kenchan0130.github.io/assets/logo.png"> <meta property="og:image:width" content="760"> <meta property="og:image:height" content="760"> <meta property="og:image:type" content="image/png"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="Spring Security SAMLでSpring BootアプリをSAML対応"> <meta name="twitter:site" content="@kenchan0130"> <meta name="twitter:description" content="Spring SecurityはSpring Bootアプリケーションの認証と認可を設定可能なフレームワークです。 標準のSpring SecurityにはOAuth2がサポートされていますがSAMLはサポートされていません。 しかし、公式がSpring SecurityのSAML Extensionを提供しており比較的容易にSAMLをサポートできます。 今回はSpring SecurityでSAML対応する方法を紹介します。"> <meta name="twitter:image" content="https://kenchan0130.github.io/assets/logo.png"> <meta name="twitter:url" content="https://kenchan0130.github.io/post/2019-12-23-1"> <link rel="preload" as="style" href="/assets/bundle/app.55445db2fff8ddfed8c5.css" onload="this.onload=null;this.rel='stylesheet'"> <noscript> <link rel="stylesheet" href="/assets/bundle/app.55445db2fff8ddfed8c5.css"> </noscript> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="https://kenchan0130.github.io/post/2019-12-23-1"> <link rel="alternate" type="application/atom+xml" title="kenchan0130 blog" href="https://kenchan0130.github.io/feed.xml"> <meta name="google-site-verification" content="ZxlKORgZZwZ4TTmaQJFFEXLF3jmd6P_NVU9TEVW1bSg"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> </head> <body> <header class="navigation" role="banner"> <div class="navigation-wrapper"> <a href="/" class="logo"> <img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="kenchan0130 blog" data-src="/assets/logo.png" class="lazyload"> </a> <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu"> <i class="fas fa-bars"></i> </a> <nav role="navigation"> <ul id="js-navigation-menu" class="navigation-menu"> <li class="nav-search-box"> <div class="search-input-container"> <input type="search" class="search-input" id="js-search-input" placeholder="Search" autocomplete="off" onfocus="gtag('event', 'search', { event_category: 'www.algolia.com/apps/DEFR5IK9E2/explorer/browse/kenchan0130_blog', event_label: '/post/2019-12-23-1' });"> <i class="fa fa-search search-input-icon"></i> <template id="suggestion-template"> <a href="" onclick="gtag('event', 'click', { event_category: 'www.algolia.com/apps/DEFR5IK9E2/explorer/browse/kenchan0130_blog', event_label: this.href });"> <p class="suggestion-title js-suggestion-title"></p> <p class="suggestion-content js-suggestion-content"></p> </a> </template> </div> </li> <li class="nav-link"> <a href="/archives">Archives</a> </li> <li class="nav-link"> <a href="/profile">Profile</a> </li> </ul> </nav> </div> </header> <div class="page-content"> <div class="post"> <div class="post-header-container "> <div class="scrim "> <header class="post-header"> <h1 class="title">Spring Security SAMLでSpring BootアプリをSAML対応</h1> </header> </div> </div> <div class="wrapper"> <span class="page-divider"> <span class="one"></span> <span class="two"></span> </span> <section class="post-meta"> <div class="post-date">2019-12-23</div> <div class="post-categories"> <i class="fas fa-fw fa-book"></i> <a href="/category/development">development </a> </div> </section> <article class="post-content"> <p>Spring SecurityはSpring Bootアプリケーションの認証と認可を設定可能なフレームワークです。</p> <p>標準のSpring SecurityにはOAuth2がサポートされていますが、SAMLは標準ではサポートされていません。 しかし、公式がSpring SecurityのSAML Extensionを提供しており比較的容易にSAMLをサポートできます。</p> <p>今回はSpring SecurityでSAML対応する方法を紹介します。</p> <p>この記事は<a href="https://qiita.com/advent-calendar/2019/folio-sec" target="_blank" rel="noopener noreferrer">FOLIO Advent Calendar 2019</a>の12月23日の記事でもあります。</p> <div class="revision"> <p class="revision-date">2020-07-02 追記</p> <p><a href="https://github.com/spring-projects/spring-security-saml" target="_blank" rel="noopener noreferrer">Spring Security SAML</a>の1系のサポートは続けられますが、この記事で紹介している2系は開発が行われません。</p> <p>現在は、<a href="https://github.com/spring-projects/spring-security" target="_blank" rel="noopener noreferrer">Spring Security</a>本体でSAMLの機能開発が進められています。</p> <p>これからSpring Securityを用いてSAMLの実装を行う場合は、Spring Security SAMLではなく、<a href="https://github.com/spring-projects/spring-security" target="_blank" rel="noopener noreferrer">Spring Security</a>のSAML実装を使用することを推奨します。</p> </div> <ul id="markdown-toc"> <li><a href="#saml%E3%81%A8%E3%81%AF" id="markdown-toc-samlとは">SAMLとは</a></li> <li><a href="#spring-security-saml" id="markdown-toc-spring-security-saml">Spring Security SAML</a></li> <li><a href="#spring-security-saml%E3%81%AE%E5%B0%8E%E5%85%A5%E3%81%AB%E3%81%82%E3%81%9F%E3%81%A3%E3%81%A6" id="markdown-toc-spring-security-samlの導入にあたって">Spring Security SAMLの導入にあたって</a></li> <li> <a href="#spring-security-saml%E3%82%92%E5%B0%8E%E5%85%A5" id="markdown-toc-spring-security-samlを導入">Spring Security SAMLを導入</a> <ul> <li><a href="#%E4%BE%9D%E5%AD%98%E3%81%AE%E8%BF%BD%E5%8A%A0" id="markdown-toc-依存の追加">依存の追加</a></li> <li><a href="#spring-security%E3%81%AE%E8%A8%AD%E5%AE%9A%E8%BF%BD%E5%8A%A0" id="markdown-toc-spring-securityの設定追加">Spring Securityの設定追加</a></li> <li><a href="#%E8%A8%AD%E5%AE%9A%E5%80%A4%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF" id="markdown-toc-設定値の読み込み">設定値の読み込み</a></li> <li><a href="#spring-security-saml%E3%81%8C%E8%A8%AD%E5%AE%9A%E5%80%A4%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B" id="markdown-toc-spring-security-samlが設定値を使用できるようにする">Spring Security SAMLが設定値を使用できるようにする</a></li> <li><a href="#spring-security%E3%81%A7spring-security-saml%E3%82%92%E4%BD%BF%E3%81%88%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B" id="markdown-toc-spring-securityでspring-security-samlを使えるようにする">Spring SecurityでSpring Security SAMLを使えるようにする</a></li> <li><a href="#%E5%90%84%E7%A8%AE%E4%B8%8D%E5%85%B7%E5%90%88%E3%82%84%E8%A6%81%E6%9C%9B%E3%81%AB%E5%AF%BE%E5%BF%9C" id="markdown-toc-各種不具合や要望に対応">各種不具合や要望に対応</a></li> </ul> </li> <li><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB" id="markdown-toc-終わりに">終わりに</a></li> </ul> <h2 id="samlとは">SAMLとは</h2> <p>SAMLはSecurity Assertion Markup Languageの略です。セキュアなWebドメイン間でユーザーの認証および承認データを交換するためのXMLベースの標準規格<sup id="fnref:SAML"><a href="#fn:SAML" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>のことです。 SAMLを使用することで、セキュアなコンテンツにアクセスしようとしているユーザーを認証できます。</p> <p>SAMLには1.1と2.0の2つのバージョンがありますが、今から導入する場合は2.0をサポートしていればよいです。</p> <h2 id="spring-security-saml">Spring Security SAML</h2> <p>執筆時点では、<strong>1.0.10</strong>がGAとしてリリースされており、2.0.0が非公開なマイルストーンで開発されています。 しかし本家の<a href="https://github.com/spring-projects/spring-security-saml/blob/873662f57b1296634fcd517f1bda38230d33cf6a/README.md" target="_blank" rel="noopener noreferrer">README（2.0.0.M31時点）</a>によると、</p> <blockquote> <p>This repository is not being actively maintained, but will remain hosted for educational and reference purposes. It contains an independent, easier to use and abstracted through Java POJOs, SAML library on top of the OpenSAML library. The concept was also validated against Keycloak as the underlying dependency.</p> <p>The effort continues at the code Spring Security project. It’s goals are to provide a framework abstraction, as opposed to a library, for SAML 2 Authentication.</p> <p>We continue to accept pull request for all branches, but will not actively drive feature development in this repository.</p> </blockquote> <p>とあるように、活発な開発が行われていません。 しかし、Spring SecurityのSAML対応のヒントになります。</p> <h2 id="spring-security-samlの導入にあたって">Spring Security SAMLの導入にあたって</h2> <p>Spring Security SAMLは前述の通り活発な開発されておらず、1系や2系どちらを使用してもいくつかの不具合が存在します。 かと言って、ゼロから作り直すのはたいへんです。</p> <p>不具合がある状態かつ一定の機能のみを限定的に使用することを許容するのであれば、<a href="https://github.com/spring-projects/spring-security-saml-dsl" target="_blank" rel="noopener noreferrer">spring-security-saml-dsl</a>を使用することで実現が可能です。</p> <p>しかし、これは健全ではないため、ここでは執筆時点で最新版の<a href="https://github.com/spring-projects/spring-security-saml/releases/tag/2.0.0.M31" target="_blank" rel="noopener noreferrer">2.0.0.M31</a>を使用してSpring BootアプリケーションにSAMLを導入する方法を紹介します。</p> <h2 id="spring-security-samlを導入">Spring Security SAMLを導入</h2> <p>公式でサンプルと合わせてドキュメント化されており、<a href="https://docs.spring.io/spring-security-saml/docs/2.0.x/reference/html/" target="_blank" rel="noopener noreferrer">Spring Security SAML Extension</a>を参考にしつつ導入します。しかし、不具合などが多く、あくまで参考程度に土留ておいたほうがよいです。</p> <p>導入にあたっては以下の環境で検証しました。</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gradle  <span class="nt">--version</span>

<span class="nt">------------------------------------------------------------</span>
Gradle 4.5.1
<span class="nt">------------------------------------------------------------</span>

Build <span class="nb">time</span>:   2018-02-05 13:22:49 UTC
Revision:     37007e1c012001ff09973e0bd095139239ecd3b3

Groovy:       2.4.12
Ant:          Apache Ant<span class="o">(</span>TM<span class="o">)</span> version 1.9.9 compiled on February 2 2017
JVM:          1.8.0_212 <span class="o">(</span>Amazon.com Inc. 25.212-b04<span class="o">)</span>
OS:           Mac OS X 10.14.6 x86_64
</code></pre></div></div> <h3 id="依存の追加">依存の追加</h3> <p>依存に<code class="language-plaintext highlighter-rouge">spring-security-saml2-core</code>を追加します。</p> <div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plugins</span> <span class="o">{</span>
  <span class="n">id</span> <span class="s1">'org.springframework.boot'</span> <span class="n">version</span> <span class="s1">'1.5.22.RELEASE'</span>
<span class="o">}</span>

<span class="n">dependencies</span> <span class="o">{</span>
  <span class="n">compile</span><span class="o">(</span><span class="s1">'org.springframework.boot:spring-boot-starter-security'</span><span class="o">)</span>
  <span class="n">compile</span><span class="o">(</span><span class="s1">'org.springframework.boot:spring-boot-starter-web'</span><span class="o">)</span>
  <span class="n">compile</span><span class="o">(</span><span class="s1">'org.springframework.boot:spring-boot-configuration-processor'</span>
  <span class="n">compile</span><span class="o">(</span><span class="s1">'org.springframework.session:spring-session'</span><span class="o">)</span>
  <span class="c1">// Spring Security SAMLの2.0.0.M31を依存に追加</span>
  <span class="n">compile</span><span class="o">(</span><span class="s1">'org.springframework.security.extensions:spring-security-saml2-core:2.0.0.M31'</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="spring-securityの設定追加">Spring Securityの設定追加</h3> <p>Spring Securityの便利なところは、フレームワークが要求する値を設定するだけで動作することです。 Spring Security SAMLでは以下のように設定することで動作します。</p> <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">security</span><span class="pi">:</span>
    <span class="na">saml2</span><span class="pi">:</span>
      <span class="na">network</span><span class="pi">:</span>
        <span class="na">read-timeout</span><span class="pi">:</span> <span class="m">10000</span>
        <span class="na">connect-timeout</span><span class="pi">:</span> <span class="m">5000</span>
      <span class="na">service-provider</span><span class="pi">:</span>
        <span class="na">entity-id</span><span class="pi">:</span> <span class="s">sampleEntityId</span>
        <span class="na">base-path</span><span class="pi">:</span> <span class="s">http://localhost:8080</span>
        <span class="na">sign-metadata</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">sign-requests</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">want-assertions-signed</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">single-logout-enabled</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">keys</span><span class="pi">:</span>
          <span class="na">active</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">spring</span>
            <span class="na">passphrase</span><span class="pi">:</span> <span class="s">secret</span>
            <span class="na">certificate</span><span class="pi">:</span> <span class="pi">|-</span>
              <span class="s">-----BEGIN CERTIFICATE-----</span>
              <span class="s">MIIDdzCCAl+gAwIBAgIEF6unJTANBgkqhkiG9w0BAQsFADBsMRAwDgYDVQQGEwdV</span>
              <span class="s">bmtub3duMRAwDgYDVQQIEwdVbmtub3duMRAwDgYDVQQHEwdVbmtub3duMRAwDgYD</span>
              <span class="s">VQQKEwdVbmtub3duMRAwDgYDVQQLEwdVbmtub3duMRAwDgYDVQQDEwdVbmtub3du</span>
              <span class="s">MB4XDTE4MDQyNjA4MTE1NloXDTQ1MDkxMTA4MTE1NlowbDEQMA4GA1UEBhMHVW5r</span>
              <span class="s">bm93bjEQMA4GA1UECBMHVW5rbm93bjEQMA4GA1UEBxMHVW5rbm93bjEQMA4GA1UE</span>
              <span class="s">ChMHVW5rbm93bjEQMA4GA1UECxMHVW5rbm93bjEQMA4GA1UEAxMHVW5rbm93bjCC</span>
              <span class="s">ASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALpDwL3nsRf7zisRb5gzw4Ia</span>
              <span class="s">i6tOAR3aMJDx/c4pVCkk3mXr3nHi88BSNWa6mhK7uwPcuBJCWJlBuPjB+zjCGxq7</span>
              <span class="s">GzQae7oxXRTsPL2SscFX2l9Sk9je8vFoo8EsFZMj0isw/lj2W9p4zbtkWUy8xU1I</span>
              <span class="s">NnlfECNSicB6UeqcsRwhHPQtmocmddGcfd7D9SpP4+YrdEFK18v24GurLnem2vKl</span>
              <span class="s">zIJGZV1SYPvWjcwDpOuR6Yc7Q+UA9jWh/A/Qb7sDG19uM6ndll2u7+9zzlUepiXB</span>
              <span class="s">+f30NhjjXlPtTOGYiegoIfFmAJawj25p7h/fXwYz+gVfOExQF5X13EVaI4eaSWkC</span>
              <span class="s">AwEAAaMhMB8wHQYDVR0OBBYEFPH6nXVDVT1HS3xc1/iBiAgl6lvZMA0GCSqGSIb3</span>
              <span class="s">DQEBCwUAA4IBAQBijy0KA3+pM+8hUklVMRRX2ZuZ3y8KrY7TeHeWQd88fyM0AjTP</span>
              <span class="s">GyND6r5JsCBZJqiC6HgycEup6TL5L9NfpNuNOQi19ouAjvrLWDygpJW9zqrVyWqz</span>
              <span class="s">Pnrl5H+6NSvd1pjWLGUwqisAKBPlIFWmWN2Z3ouDqc1rwgF4KZrjLW3v/+yILdjb</span>
              <span class="s">lVR0r8o70ynOiUB2VN/7WX2a6MuBXv3JiPiyhqFdWFhcRWphZjo4Yh8dApj79d15</span>
              <span class="s">MXI5uAm5K7ZHZsWFNvjnwxuhWwDURldvqL1VuChxD4hgfXO4t+oDQMQDa5tn6Ov5</span>
              <span class="s">68aQRwURcoufrRJ6R0drTEQueJszi6FVx5Ld</span>
              <span class="s">-----END CERTIFICATE-----</span>
        <span class="na">providers</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">alias</span><span class="pi">:</span> <span class="s">simpleSAMLphp</span>
            <span class="na">metadata</span><span class="pi">:</span> <span class="s">http://localhost:4000/simplesaml/saml2/idp/metadata.php</span>
            <span class="na">authentication-request-binding</span><span class="pi">:</span> <span class="s">urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST</span>
            <span class="na">skip-ssl-validation</span><span class="pi">:</span> <span class="kc">true</span>
            <span class="na">assertion-consumer-service-index</span><span class="pi">:</span> <span class="m">0</span>
</code></pre></div></div> <p>特に注意するべき項目は、</p> <ol> <li><code class="language-plaintext highlighter-rouge">spring.security.saml2.service-provider.entity-id</code></li> <li><code class="language-plaintext highlighter-rouge">spring.security.saml2.service-provider.keys</code></li> <li>ここには記載はないですが、<code class="language-plaintext highlighter-rouge">spring.security.saml2.service-provider.name-ids</code> </li> </ol> <p>の3点です。</p> <h4 id="springsecuritysaml2service-providerentity-idの注意点">spring.security.saml2.service-provider.entity-idの注意点</h4> <p><code class="language-plaintext highlighter-rouge">spring.security.saml2.service-provider.entity-id</code>は、Service ProviderをIdentity Provider側に一意に特定するためのエンティティIDです。Spring Security SAMLは実装上、Assertion Consumer Service<sup id="fnref:ACS"><a href="#fn:ACS" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>のURLが<code class="language-plaintext highlighter-rouge">[hostname]/[SamlPrefix]/SSO/alias/[EntityID]</code>となる点に注意が必要ですで<strong>SamlPrefix</strong>はデフォルトで<code class="language-plaintext highlighter-rouge">saml/sp</code>ですが、Spring Securityの設定箇所で変更ができます。</p> <h4 id="springsecuritysaml2service-providerkeysの注意点">spring.security.saml2.service-provider.keysの注意点</h4> <p><code class="language-plaintext highlighter-rouge">spring.security.saml2.service-provider.keys</code>はService Providerのmetadataを署名する際に使用する鍵の設定です。 Microsoft Azure Active Directoryなどの多くのIdentity Providerはこの署名を確認しないため、必須ではありません。 しかし、Spring Security SAMLは必須として要求してくるため、ダミーの証明書を使用して署名する対応をする必要がある点に注意が必要です。</p> <h4 id="springsecuritysaml2service-providername-idsの注意点">spring.security.saml2.service-provider.name-idsの注意点</h4> <p><code class="language-plaintext highlighter-rouge">spring.security.saml2.service-provider.name-ids</code>は必須ではありません。 また、ymlで設定する分には特に問題ありません。 詳しく検証できていませんが、propertiesの形式で記載するとSpring Security SAMLが提供する<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/saml2/metadata/NameId.java" target="_blank" rel="noopener noreferrer">NameId</a>型に変換されない不具合があります。</p> <h3 id="設定値の読み込み">設定値の読み込み</h3> <p>前述した設定値を読み込むために<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/provider/SamlServerConfiguration.java" target="_blank" rel="noopener noreferrer">SamlServerConfiguration</a>を継承したクラスを作成します。<code class="language-plaintext highlighter-rouge">@ConfigurationProperties</code>アノテーションで<code class="language-plaintext highlighter-rouge">spring.security.saml2</code>を指定します。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.boot.context.properties.ConfigurationProperties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.SamlServerConfiguration</span><span class="o">;</span>

<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">"spring.security.saml2"</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SamlSecurityConfiguration</span> <span class="kd">extends</span> <span class="nc">SamlServerConfiguration</span> <span class="o">{}</span>
</code></pre></div></div> <h3 id="spring-security-samlが設定値を使用できるようにする">Spring Security SAMLが設定値を使用できるようにする</h3> <p>前述の<code class="language-plaintext highlighter-rouge">SamlServerConfiguration</code>を継承したクラス、つまり設定値をSpring Security SAMLが使用できるようにするために<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/provider/service/config/SamlServiceProviderServerBeanConfiguration.java" target="_blank" rel="noopener noreferrer">SamlServiceProviderServerBeanConfiguration</a>を継承したクラスの<code class="language-plaintext highlighter-rouge">getDefaultHostSamlServerConfiguration</code>メソッドをオーバーライドして<code class="language-plaintext highlighter-rouge">SamlServerConfiguration</code>のインスタンスを使用するように設定します。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.SamlServerConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.service.config.SamlServiceProviderServerBeanConfiguration</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SamlServerBeanConfiguration</span> <span class="kd">extends</span> <span class="nc">SamlServiceProviderServerBeanConfiguration</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">SamlSecurityConfiguration</span> <span class="n">config</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">SamlServerBeanConfiguration</span><span class="o">(</span><span class="nc">SamlSecurityConfiguration</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="nc">SamlServerConfiguration</span> <span class="nf">getDefaultHostSamlServerConfiguration</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">config</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>しかし、これだと<a href="https://github.com/spring-projects/spring-security-saml/issues/469" target="_blank" rel="noopener noreferrer">設定したIdentity Providerを呼び出せない不具合</a>が発生してしまします。</p> <p>そのため、以下のようなワークアラウンドで回避します。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.SamlServerConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.service.config.ExternalIdentityProviderConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.service.config.SamlServiceProviderServerBeanConfiguration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SamlServerBeanConfiguration</span> <span class="kd">extends</span> <span class="nc">SamlServiceProviderServerBeanConfiguration</span> <span class="o">{</span>
  <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.security.saml2.service-provider.providers[0].metadata}"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">metadata</span><span class="o">;</span>

  <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.security.saml2.service-provider.providers[0].alias}"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">alias</span><span class="o">;</span>

  <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.security.saml2.service-provider.providers[0].authentication-request-binding}"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">authenticationRequestBinding</span><span class="o">;</span>

  <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.security.saml2.service-provider.providers[0].skip-ssl-validation}"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">skipSslValidation</span><span class="o">;</span>

  <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.security.saml2.service-provider.providers[0].assertion-consumer-service-index}"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">assertionConsumerServiceIndex</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">SamlSecurityConfiguration</span> <span class="n">config</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">SamlServerBeanConfiguration</span><span class="o">(</span><span class="nc">SamlSecurityConfiguration</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="nc">SamlServerConfiguration</span> <span class="nf">getDefaultHostSamlServerConfiguration</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ExternalIdentityProviderConfiguration</span><span class="o">&gt;</span> <span class="n">providers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="n">providers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">externalProvider</span><span class="o">());</span>
    <span class="c1">// providers の properties を公式の指定通りに定義すると ClassCastException が起こるので独自に定義し直している</span>
    <span class="n">config</span><span class="o">.</span><span class="na">getServiceProvider</span><span class="o">().</span><span class="na">setProviders</span><span class="o">(</span><span class="n">providers</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">ExternalIdentityProviderConfiguration</span> <span class="nf">externalProvider</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ExternalIdentityProviderConfiguration</span> <span class="n">externalIdentityProviderConfiguration</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nf">ExternalIdentityProviderConfiguration</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">externalIdentityProviderConfiguration</span>
        <span class="o">.</span><span class="na">setMetadata</span><span class="o">(</span><span class="n">metadata</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setAlias</span><span class="o">(</span><span class="n">alias</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setSkipSslValidation</span><span class="o">(</span><span class="n">skipSslValidation</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setAuthenticationRequestBinding</span><span class="o">(</span><span class="no">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">authenticationRequestBinding</span><span class="o">))</span>
        <span class="o">.</span><span class="na">setAssertionConsumerServiceIndex</span><span class="o">(</span><span class="n">assertionConsumerServiceIndex</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>これにより、型のキャストができます。 今回は1つのIdentity Providerのみを設定しているため、<code class="language-plaintext highlighter-rouge">spring.security.saml2.service-provider.providers[0]</code>のような形で設定値を取得しましたが、複数ある場合はリストで<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/provider/service/config/ExternalIdentityProviderConfiguration.java" target="_blank" rel="noopener noreferrer">ExternalIdentityProviderConfiguration</a>を生成すると良いでしょう。</p> <h3 id="spring-securityでspring-security-samlを使えるようにする">Spring SecurityでSpring Security SAMLを使えるようにする</h3> <p>Spring Security SAMLをSpring Securityで使用できるようにします。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.annotation.Order</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.EnableWebSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.service.config.SamlServiceProviderSecurityConfiguration</span><span class="o">;</span>

<span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfiguration</span> <span class="o">{</span>

  <span class="nd">@Configuration</span>
  <span class="nd">@Order</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SamlSecurity</span> <span class="kd">extends</span> <span class="nc">SamlServiceProviderSecurityConfiguration</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">SamlSecurityConfiguration</span> <span class="n">samlSecurityConfiguration</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SamlSecurity</span><span class="o">(</span>
        <span class="nc">SamlServerBeanConfiguration</span> <span class="n">samlServerBeanConfiguration</span><span class="o">,</span>
        <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"samlSecurityConfiguration"</span><span class="o">)</span>
            <span class="nc">SamlSecurityConfiguration</span> <span class="n">samlSecurityConfiguration</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">samlServerBeanConfiguration</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">samlSecurityConfiguration</span> <span class="o">=</span> <span class="n">samlSecurityConfiguration</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Configuration</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AppSecurity</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
        <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">permitAll</span><span class="o">()</span>
        <span class="o">.</span><span class="na">anyRequest</span><span class="o">()</span>
        <span class="o">.</span><span class="na">authenticated</span><span class="o">()</span>
        <span class="o">.</span><span class="na">and</span><span class="o">()</span>
        <span class="o">.</span><span class="na">logout</span><span class="o">()</span>
        <span class="o">.</span><span class="na">deleteCookies</span><span class="o">(</span><span class="s">"xxxxx"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">invalidateHttpSession</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">logoutUrl</span><span class="o">(</span><span class="s">"/logout"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">logoutSuccessUrl</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">and</span><span class="o">()</span>
        <span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
        <span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">"/login"</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>これでかゆいところに手が届かない、および不具合がありつつもSpring Bootアプリケーションが起動し、SAMLでログインが可能になりました。</p> <p>認証情報はSpring Bootのセッションに<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/spi/DefaultSamlAuthentication.java" target="_blank" rel="noopener noreferrer">DefaultSamlAuthentication</a>インスタンスが格納されているので、<code class="language-plaintext highlighter-rouge">org.springframework.security.core.Authentication</code>をキャストすることで取得できます。</p> <h3 id="各種不具合や要望に対応">各種不具合や要望に対応</h3> <p>ここでは公式ドキュメントどおりに設定しても対応が難しい不具合や要望の対応する方法を紹介します。</p> <h4 id="すべてのページで認証が無効化される">すべてのページで認証が無効化される</h4> <p>SAMLでSSOするからには何かしら認証が通らないとアクセスさせないようなページがあると思われます。 しかし、<a href="https://github.com/spring-projects/spring-security-saml/pull/468" target="_blank" rel="noopener noreferrer">SamlServiceProviderSecurityConfigurationの不具合</a>により、すべてのページで認証が必要なくない状態になってしまいます。 そのため、不具合が解消されるまでは以下のように対応する必要があります。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.annotation.Order</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.EnableWebSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.service.config.SamlServiceProviderSecurityConfiguration</span><span class="o">;</span>

<span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfiguration</span> <span class="o">{</span>

  <span class="nd">@Configuration</span>
  <span class="nd">@Order</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SamlSecurity</span> <span class="kd">extends</span> <span class="nc">SamlServiceProviderSecurityConfiguration</span> <span class="o">{</span>
    <span class="c1">// 今回追加したもの</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="kd">final</span> <span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">getPrefix</span><span class="o">();</span>

      <span class="nc">String</span> <span class="n">filterChainPattern</span> <span class="o">=</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">stripSlashes</span><span class="o">(</span><span class="n">prefix</span><span class="o">)</span> <span class="o">+</span> <span class="s">"/**"</span><span class="o">;</span>

      <span class="n">http</span><span class="o">.</span><span class="na">antMatcher</span><span class="o">(</span><span class="n">filterChainPattern</span><span class="o">)</span>
          <span class="o">.</span><span class="na">csrf</span><span class="o">()</span>
          <span class="o">.</span><span class="na">disable</span><span class="o">()</span>
          <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
          <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="n">filterChainPattern</span><span class="o">)</span>
          <span class="o">.</span><span class="na">permitAll</span><span class="o">();</span>

      <span class="c1">// スーパークラスではspSelectIdentityProviderFilterも追加しているがしているがその画面は複数Identity Providerがないと意味がないので外している</span>
      <span class="n">http</span>
        <span class="o">.</span><span class="na">addFilterAfter</span><span class="o">(</span>
          <span class="n">getConfiguration</span><span class="o">().</span><span class="na">samlConfigurationFilter</span><span class="o">(),</span>
          <span class="nc">BasicAuthenticationFilter</span><span class="o">.</span><span class="na">class</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">addFilterAfter</span><span class="o">(</span>
          <span class="n">getConfiguration</span><span class="o">().</span><span class="na">spMetadataFilter</span><span class="o">(),</span>
          <span class="n">getConfiguration</span><span class="o">().</span><span class="na">samlConfigurationFilter</span><span class="o">().</span><span class="na">getClass</span><span class="o">()</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">addFilterAfter</span><span class="o">(</span>
          <span class="n">getConfiguration</span><span class="o">().</span><span class="na">spAuthenticationRequestFilter</span><span class="o">(),</span>
          <span class="n">getConfiguration</span><span class="o">().</span><span class="na">spMetadataFilter</span><span class="o">().</span><span class="na">getClass</span><span class="o">()</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">addFilterAfter</span><span class="o">(</span>
          <span class="n">getConfiguration</span><span class="o">().</span><span class="na">spAuthenticationResponseFilter</span><span class="o">(),</span>
          <span class="n">getConfiguration</span><span class="o">().</span><span class="na">spAuthenticationRequestFilter</span><span class="o">().</span><span class="na">getClass</span><span class="o">()</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">addFilterAfter</span><span class="o">(</span>
          <span class="n">getConfiguration</span><span class="o">().</span><span class="na">spSamlLogoutFilter</span><span class="o">(),</span>
          <span class="n">getConfiguration</span><span class="o">().</span><span class="na">spAuthenticationResponseFilter</span><span class="o">().</span><span class="na">getClass</span><span class="o">()</span>
        <span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="identity-providerのセッションの発行日のチェックを無視">Identity Providerのセッションの発行日のチェックを無視</h4> <p>Spring Security SAMLは<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/spi/DefaultValidator.java" target="_blank" rel="noopener noreferrer">DefaultValidator</a>でIdentity Providerのセッションの発行日を厳格にチェックしています。 しかし、Identity Providerから正しいリクエストがきているので、セッションの発行日を信頼するかはService Provider次第です。そのため、このチェックをなくしたいという要望があります。</p> <p>一番簡単な方法は<code class="language-plaintext highlighter-rouge">DefaultValidator</code>を継承し、セッションの発行日の確認をしているメソッドを上書きしてしまうことです。 ゼロから<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/SamlValidator.java" target="_blank" rel="noopener noreferrer">SamlValidator</a>を継承したクラスを作成してもよいですが、SAMLの各種レスポンスをチェックするのは面倒であるため、この手法を選択しました。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomSamlValidator</span> <span class="kd">extends</span> <span class="nc">DefaultValidator</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">AzureAdSamlValidator</span><span class="o">(</span><span class="nc">SpringSecuritySaml</span> <span class="n">implementation</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">implementation</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isDateTimeSkewValid</span><span class="o">(</span><span class="kt">int</span> <span class="n">skewSeconds</span><span class="o">,</span> <span class="kt">int</span> <span class="n">forwardSeconds</span><span class="o">,</span> <span class="nc">DateTime</span> <span class="n">time</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>独自に拡張したSamlValidatorをSpring Security SAMLに設定する必要があるので、<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/provider/service/config/SamlServiceProviderServerBeanConfiguration.java" target="_blank" rel="noopener noreferrer">SamlServiceProviderServerBeanConfiguration</a>を継承したクラスで<code class="language-plaintext highlighter-rouge">samlValidator</code>メソッドをオーバーライドして設定します。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.SamlValidator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.SamlServerConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.service.config.SamlServiceProviderServerBeanConfiguration</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SamlServerBeanConfiguration</span> <span class="kd">extends</span> <span class="nc">SamlServiceProviderServerBeanConfiguration</span> <span class="o">{</span>
  <span class="c1">// 今回追加したもの</span>
  <span class="nd">@Autowired</span> <span class="kd">private</span> <span class="nc">SpringSecuritySaml</span> <span class="n">samlImplementation</span><span class="o">;</span>

  <span class="c1">// 今回追加したもの</span>
  <span class="nd">@Override</span>
  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">SamlValidator</span> <span class="nf">samlValidator</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">CustomSamlValidator</span><span class="o">(</span><span class="n">samlImplementation</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="spring-security-saml独自のエラー画面を無効化">Spring Security SAML独自のエラー画面を無効化</h4> <p>SAMLの処理中に何かしらの例外が発生した際に、Spring Security SAMLは独自のエラー画面を表示してしまいます。 しかし、例外時のエラー画面はアプリケーションによって調整したいものです。</p> <p>以下は、Springの<code class="language-plaintext highlighter-rouge">AuthenticationFailureHandler</code>を利用してセッションに例外をセットしてして指定されたURLにリダイレクトするハンドラです。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.DefaultRedirectStrategy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.RedirectStrategy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.WebAttributes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.AuthenticationFailureHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SamlErrorAuthenticationFailureHandler</span> <span class="kd">implements</span> <span class="nc">AuthenticationFailureHandler</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span>
      <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">SamlErrorAuthenticationFailureHandler</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">redirectUrl</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">RedirectStrategy</span> <span class="n">redirectStrategy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultRedirectStrategy</span><span class="o">();</span>

  <span class="kd">public</span> <span class="nf">SamlErrorAuthenticationFailureHandler</span><span class="o">(</span><span class="nc">String</span> <span class="n">redirectUrl</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">redirectUrl</span> <span class="o">=</span> <span class="n">redirectUrl</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationFailure</span><span class="o">(</span>
      <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">AuthenticationException</span> <span class="n">exception</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
    <span class="n">saveException</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
    <span class="n">getRedirectStrategy</span><span class="o">().</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">getRedirectUrl</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">saveException</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">AuthenticationException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="n">exception</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">exception</span><span class="o">);</span>
    <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="nc">WebAttributes</span><span class="o">.</span><span class="na">AUTHENTICATION_EXCEPTION</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRedirectStrategy</span><span class="o">(</span><span class="nc">RedirectStrategy</span> <span class="n">redirectStrategy</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">redirectStrategy</span> <span class="o">=</span> <span class="n">redirectStrategy</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">protected</span> <span class="nc">RedirectStrategy</span> <span class="nf">getRedirectStrategy</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">redirectStrategy</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">getRedirectUrl</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">redirectUrl</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>Spring Security SAMLに設定する必要があるので、<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/provider/service/config/SamlServiceProviderServerBeanConfiguration.java" target="_blank" rel="noopener noreferrer">SamlServiceProviderServerBeanConfiguration</a>を継承したクラスで<code class="language-plaintext highlighter-rouge">spAuthenticationResponseFilter</code>メソッドをオーバーライドします。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">javax.servlet.Filter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.service.authentication.SamlAuthenticationResponseFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.service.config.SamlServiceProviderServerBeanConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.SavedRequestAwareAuthenticationSuccessHandler</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SamlServerBeanConfiguration</span> <span class="kd">extends</span> <span class="nc">SamlServiceProviderServerBeanConfiguration</span> <span class="o">{</span>

  <span class="c1">// 今回追加したもの</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Filter</span> <span class="nf">spAuthenticationResponseFilter</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">SamlAuthenticationResponseFilter</span> <span class="n">authenticationFilter</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SamlAuthenticationResponseFilter</span><span class="o">)</span> <span class="kd">super</span><span class="o">.</span><span class="na">spAuthenticationResponseFilter</span><span class="o">()</span>
    <span class="n">authenticationFilter</span><span class="o">.</span><span class="na">setAuthenticationFailureHandler</span><span class="o">(</span>
        <span class="k">new</span> <span class="nf">SamlErrorAuthenticationFailureHandler</span><span class="o">(</span><span class="s">"/login"</span><span class="o">));</span>

    <span class="k">return</span> <span class="n">authenticationFilter</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="identity-providerのレスポンス属性を使用したい">Identity Providerのレスポンス属性を使用したい</h4> <p>Identity Providerの多くはレスポンスにメールアドレスなどの情報を付加します。 その中でも<code class="language-plaintext highlighter-rouge">AttributeStatement</code>にはカスタム値が格納されており、使用したいケースがあります。 しかし、<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/provider/service/authentication/SimpleAuthenticationManager.java" target="_blank" rel="noopener noreferrer">SimpleAuthenticationManager</a>ではカスタム値はパースされず<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/spi/DefaultSamlAuthentication.java" target="_blank" rel="noopener noreferrer">DefaultSamlAuthentication</a>インスタンスとしてピュアなstringとして保持されているだけです。 また、このXMLを使用するたびに毎回パースするのはコストが高いため、一度だけパースされて認証情報として保持されていてほしいです。</p> <p>まずは、なにをするにしてもXMLをパースしなければいけません。SAMLレスポンスのXMLは名前空間がついている可能性があるのでそれを考慮してパースする必要があります。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.ByteArrayInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.namespace.NamespaceContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilderFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.ParserConfigurationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.w3c.dom.Document</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.w3c.dom.Node</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.w3c.dom.NodeList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SamlResponseXmlParser</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">XPathFactory</span> <span class="n">xPathFactory</span><span class="o">;</span>

  <span class="kd">static</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">xPathFactory</span> <span class="o">=</span>
          <span class="nc">XPathFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span>
              <span class="nc">XPathFactory</span><span class="o">.</span><span class="na">DEFAULT_OBJECT_MODEL_URI</span><span class="o">,</span>
              <span class="s">"com.sun.org.apache.xpath.internal.jaxp.XPathFactoryImpl"</span><span class="o">,</span>
              <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ClassLoader</span><span class="o">.</span><span class="na">getSystemClassLoader</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">XPathFactoryConfigurationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Generated XPathFactory instance error."</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">String</span> <span class="n">responseXml</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Document</span> <span class="n">document</span><span class="o">;</span>
  <span class="c1">// See also:</span>
  <span class="c1">// http://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-tech-overview-2.0-cd-02.html#4.4.3.Attribute%20Statement%20Structure|outline</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">RESPONSE_ATTRIBUTE_XPATH</span> <span class="o">=</span>
      <span class="s">"/samlp:Response/saml:Assertion/saml:AttributeStatement/saml:Attribute"</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">SamlResponseXmlParser</span><span class="o">(</span><span class="nc">String</span> <span class="n">responseXml</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">responseXml</span> <span class="o">=</span> <span class="n">responseXml</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SamlResponseAttribute</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">XPath</span> <span class="n">xPath</span> <span class="o">=</span> <span class="n">xPathFactory</span><span class="o">.</span><span class="na">newXPath</span><span class="o">();</span>
      <span class="nc">NamespaceContext</span> <span class="n">namespaceContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SamlNamespaceResolver</span><span class="o">();</span>
      <span class="n">xPath</span><span class="o">.</span><span class="na">setNamespaceContext</span><span class="o">(</span><span class="n">namespaceContext</span><span class="o">);</span>
      <span class="nc">XPathExpression</span> <span class="n">attributesXPath</span> <span class="o">=</span> <span class="n">xPath</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="no">RESPONSE_ATTRIBUTE_XPATH</span><span class="o">);</span>
      <span class="nc">NodeList</span> <span class="n">nl</span> <span class="o">=</span> <span class="o">(</span><span class="nc">NodeList</span><span class="o">)</span> <span class="n">attributesXPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getDocument</span><span class="o">(),</span> <span class="nc">XPathConstants</span><span class="o">.</span><span class="na">NODESET</span><span class="o">);</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SamlResponseAttribute</span><span class="o">&gt;</span> <span class="n">attributes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">SamlResponseAttribute</span><span class="o">&gt;();</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span> <span class="n">attributeNode</span> <span class="o">:</span> <span class="nc">XmlUtil</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">nl</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">attributeValues</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">attributeNode</span><span class="o">.</span><span class="na">hasChildNodes</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span> <span class="n">attributeValueNode</span> <span class="o">:</span> <span class="nc">XmlUtil</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">attributeNode</span><span class="o">.</span><span class="na">getChildNodes</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">attributeValues</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">attributeValueNode</span><span class="o">.</span><span class="na">getTextContent</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">attributes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
            <span class="k">new</span> <span class="nf">SamlResponseAttribute</span><span class="o">(</span>
                <span class="n">attributeNode</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">().</span><span class="na">getNamedItem</span><span class="o">(</span><span class="s">"Name"</span><span class="o">).</span><span class="na">getNodeValue</span><span class="o">(),</span>
                <span class="n">attributeValues</span><span class="o">));</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">attributes</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">XPathExpressionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
          <span class="s">"Set invalid xpath expression. Please check your xpath expression"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Document</span> <span class="nf">getDocument</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">document</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">document</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nc">DocumentBuilderFactory</span> <span class="n">documentBuilderFactory</span> <span class="o">=</span> <span class="nc">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="n">documentBuilderFactory</span><span class="o">.</span><span class="na">setNamespaceAware</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">DocumentBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">documentBuilderFactory</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">document</span> <span class="o">=</span>
          <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span>
              <span class="k">new</span> <span class="nf">ByteArrayInputStream</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">responseXml</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)));</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">document</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ParserConfigurationException</span> <span class="o">|</span> <span class="nc">SAXException</span> <span class="o">|</span> <span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SamlNamespaceResolver</span> <span class="kd">implements</span> <span class="nc">NamespaceContext</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getNamespaceURI</span><span class="o">(</span><span class="nc">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">prefix</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"samlp"</span><span class="o">)</span> <span class="o">||</span> <span class="n">prefix</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"samlp2"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nc">Constants</span><span class="o">.</span><span class="na">NS_SAMLP</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">prefix</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"saml"</span><span class="o">)</span> <span class="o">||</span> <span class="n">prefix</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"saml2"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nc">Constants</span><span class="o">.</span><span class="na">NS_SAML</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">prefix</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"ds"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nc">Constants</span><span class="o">.</span><span class="na">NS_DS</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">prefix</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"xenc"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nc">Constants</span><span class="o">.</span><span class="na">NS_XENC</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">prefix</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"md"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nc">Constants</span><span class="o">.</span><span class="na">NS_MD</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getPrefix</span><span class="o">(</span><span class="nc">String</span> <span class="n">namespaceURI</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Iterator</span> <span class="nf">getPrefixes</span><span class="o">(</span><span class="nc">String</span> <span class="n">namespaceURI</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">XmlUtil</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nf">XmlUtil</span><span class="o">()</span> <span class="o">{}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Node</span><span class="o">&gt;</span> <span class="nf">asList</span><span class="o">(</span><span class="nc">NodeList</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">n</span><span class="o">.</span><span class="na">getLength</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="nc">Collections</span><span class="o">.&lt;</span><span class="nc">Node</span><span class="o">&gt;</span><span class="n">emptyList</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">NodeListWrapper</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">NodeListWrapper</span> <span class="kd">extends</span> <span class="nc">AbstractList</span><span class="o">&lt;</span><span class="nc">Node</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">RandomAccess</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="nc">NodeList</span> <span class="n">list</span><span class="o">;</span>

      <span class="nc">NodeListWrapper</span><span class="o">(</span><span class="nc">NodeList</span> <span class="n">l</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">list</span> <span class="o">=</span> <span class="n">l</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="nc">Node</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>XMLがパースできたので、パースしたものを取得できるように<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/SamlAuthentication.java" target="_blank" rel="noopener noreferrer">SamlAuthentication</a>インタフェースが実装されているクラスを作成します。 今回は面倒だったので<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/spi/DefaultSamlAuthentication.java" target="_blank" rel="noopener noreferrer">DefaultSamlAuthentication</a>を継承して作成します。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.saml2.authentication.Assertion</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.spi.DefaultSamlAuthentication</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAuthentication</span> <span class="kd">extends</span> <span class="nc">DefaultSamlAuthentication</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SamlResponseAttribute</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">SamlResponseXmlParser</span> <span class="n">samlResponseXmlParser</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">CustomAuthentication</span><span class="o">(</span>
      <span class="kt">boolean</span> <span class="n">authenticated</span><span class="o">,</span>
      <span class="nc">Assertion</span> <span class="n">assertion</span><span class="o">,</span>
      <span class="nc">String</span> <span class="n">assertingEntityId</span><span class="o">,</span>
      <span class="nc">String</span> <span class="n">holdingEntityId</span><span class="o">,</span>
      <span class="nc">String</span> <span class="n">relayState</span><span class="o">,</span>
      <span class="nc">String</span> <span class="n">responseXml</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">authenticated</span><span class="o">,</span> <span class="n">assertion</span><span class="o">,</span> <span class="n">assertingEntityId</span><span class="o">,</span> <span class="n">holdingEntityId</span><span class="o">,</span> <span class="n">relayState</span><span class="o">);</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">setResponseXml</span><span class="o">(</span><span class="n">responseXml</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SamlResponseAttribute</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">attributes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">attributes</span> <span class="o">=</span> <span class="n">samlResponseXmlParser</span><span class="o">().</span><span class="na">getAttributes</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">attributes</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">SamlResponseXmlParser</span> <span class="nf">samlResponseXmlParser</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">samlResponseXmlParser</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">samlResponseXmlParser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SamlResponseXmlParser</span><span class="o">(</span><span class="n">getResponseXml</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">samlResponseXmlParser</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>この認証情報を保持するインスタンスをSpring Securityで使用できるようにするにはSpringの<code class="language-plaintext highlighter-rouge">AuthenticationManager</code>インタフェースの実装に組み込まれている必要があります。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.security.authentication.AuthenticationManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.spi.DefaultSamlAuthentication</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAuthenticationManager</span> <span class="kd">implements</span> <span class="nc">AuthenticationManager</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">authenticate</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span> <span class="o">{</span>
    <span class="nc">DefaultSamlAuthentication</span> <span class="n">defaultSamlAuthentication</span> <span class="o">=</span>
        <span class="o">(</span><span class="nc">DefaultSamlAuthentication</span><span class="o">)</span> <span class="n">authentication</span><span class="o">;</span>
    <span class="nc">CustomAuthentication</span> <span class="n">customAuthentication</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nf">CustomAuthentication</span><span class="o">(</span>
            <span class="n">defaultSamlAuthentication</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">(),</span>
            <span class="n">defaultSamlAuthentication</span><span class="o">.</span><span class="na">getAssertion</span><span class="o">(),</span>
            <span class="n">defaultSamlAuthentication</span><span class="o">.</span><span class="na">getAssertingEntityId</span><span class="o">(),</span>
            <span class="n">defaultSamlAuthentication</span><span class="o">.</span><span class="na">getHoldingEntityId</span><span class="o">(),</span>
            <span class="n">defaultSamlAuthentication</span><span class="o">.</span><span class="na">getRelayState</span><span class="o">(),</span>
            <span class="n">defaultSamlAuthentication</span><span class="o">.</span><span class="na">getResponseXml</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">customAuthentication</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">customAuthentication</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>この<code class="language-plaintext highlighter-rouge">AuthenticationManager</code>をSpring Security SAMLに設定する必要があるので、<a href="https://github.com/spring-projects/spring-security-saml/blob/b06f7e18f4593e29be637afe563a31f74b12e12c/core/src/main/java/org/springframework/security/saml/provider/service/config/SamlServiceProviderServerBeanConfiguration.java" target="_blank" rel="noopener noreferrer">SamlServiceProviderServerBeanConfiguration</a>を継承したクラスで<code class="language-plaintext highlighter-rouge">spAuthenticationResponseFilter</code>メソッドをオーバーライドします</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">javax.servlet.Filter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.service.authentication.SamlAuthenticationResponseFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.saml.provider.service.config.SamlServiceProviderServerBeanConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.SavedRequestAwareAuthenticationSuccessHandler</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SamlServerBeanConfiguration</span> <span class="kd">extends</span> <span class="nc">SamlServiceProviderServerBeanConfiguration</span> <span class="o">{</span>

  <span class="c1">// 今回追加したもの</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Filter</span> <span class="nf">spAuthenticationResponseFilter</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">SamlAuthenticationResponseFilter</span> <span class="n">authenticationFilter</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SamlAuthenticationResponseFilter</span><span class="o">)</span> <span class="kd">super</span><span class="o">.</span><span class="na">spAuthenticationResponseFilter</span><span class="o">()</span>
    <span class="n">authenticationFilter</span><span class="o">.</span><span class="na">setAuthenticationManager</span><span class="o">(</span><span class="k">new</span> <span class="nc">CustomAuthenticationManager</span><span class="o">());</span>

    <span class="k">return</span> <span class="n">authenticationFilter</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>これにより、<code class="language-plaintext highlighter-rouge">SecurityContextHolder</code>のコンテキストを介して以下のようにして認証情報を取得できます。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="o">;</span>

<span class="kd">public</span> <span class="nc">AuthenticationUtils</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">CustomAuthentication</span> <span class="nf">getAuthentication</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">CustomAuthentication</span> <span class="n">customAuthentication</span> <span class="o">=</span>
          <span class="o">(</span><span class="nc">CustomAuthentication</span><span class="o">)</span> <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">customAuthentication</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h2 id="終わりに">終わりに</h2> <p>Spring BootアプリケーションでSAMLを使用したSSOの対応方法を紹介しました。 いくつかの不具合のために独自のパッチを当てて対応する必要があり、容易に導入というわけにはいきませんでした。</p> <p>この量のカスタマイズが必要なのであれば、本家のサポートの状態と合わせて鑑みると別途ライブラリ化するなどの対応が必要であると感じました。 事業の状況によってそのような時間が取れない場合は、同じように独自にカスタマイズすることが無難な場合もあると思いますので、その際には参考になれば幸いです。</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:SAML"> <p><a href="https://tools.ietf.org/html/rfc7522" target="_blank" rel="noopener noreferrer">RFC7522</a>で標準化 <a href="#fnref:SAML" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:ACS"> <p>Assertion Consumer Serviceは、Identity ProviderのAssertionを渡す先（Service ProviderのURL） <a href="#fnref:ACS" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </article> <section class="share"> <a href="//twitter.com/share?text=Spring+Security+SAML%E3%81%A7Spring+Boot%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92SAML%E5%AF%BE%E5%BF%9C&amp;url=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2019-12-23-1%3Futm_source%3Dtwitter%26utm_medium%3Dsocial&amp;via=kenchan0130" onclick="window.open(this.href, 'twitter-share', 'width=550,height=255,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-twitter fa-lg"></i> </a> <a href="//www.facebook.com/sharer.php?t=Spring+Security+SAML%E3%81%A7Spring+Boot%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92SAML%E5%AF%BE%E5%BF%9C&amp;u=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2019-12-23-1%3Futm_source%3Dfacebook%26utm_medium%3Dsocial" onclick="window.open(this.href, 'facebook-share', 'width=550,height=255,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-facebook fa-lg"></i> </a> <a href="//b.hatena.ne.jp/entry/panel/?btitle=Spring+Security+SAML%E3%81%A7Spring+Boot%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92SAML%E5%AF%BE%E5%BF%9C&amp;url=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2019-12-23-1" onclick="window.open(this.href, 'hatena-share', 'width=550,height=600,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-hatena fa-lg"></i> </a> </section> <section class="post-donation"> <div class="post-donation-panel"> <p class="post-donation-description"> 参考になった・面白かったと感じていただけましたら、サポートいただけると励みになります。 </p> <a class="post-donation-button" href="https://www.buymeacoffee.com/kenchan0130" onclick="gtag('event', 'click-buymeacoffee', { event_category: 'www.buymeacoffee.com/kenchan0130', event_label: '/post/2019-12-23-1' });" target="_blank" rel="noopener noreferrer"> <p class="post-donation-button-body"> <img class="icon lazyload" alt="buymeacoffee" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg"> <span class="label">サポートする</span> </p> </a> </div> </section> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2444060431947599" data-ad-slot="7319689305" data-ad-format="auto"></ins> <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script> <section class="sub-contents related-posts"> <div class="sub-contents-wrapper"> <div class="sub-contents-title">あわせて読みたい</div> <div class="sub-contents-main"> <li> <a href="/post/2019-12-24-1">SAML認証が検証可能な開発環境用のIdPを構築</a> <span class="post-date">- December 24, 2019</span> </li> <li> <a href="/post/2019-12-24-2">Google ColaboratoryのRランタイムでCSVを操作してみる</a> <span class="post-date">- December 24, 2019</span> </li> </div> </div> </section> <section class="sub-contents tags"> <div class="sub-contents-wrapper"> <div class="sub-contents-title">Tags</div> <div class="sub-contents-main"> <a href="/tag/saml">SAML</a> <a href="/tag/spring-boot">Spring Boot</a> <a href="/tag/spring-security">Spring Security</a> <a href="/tag/java">Java</a> </div> </div> </section> </div> </div> </div> <footer class="site-footer"> <div class="wrapper"> <h3 class="footer-heading">kenchan0130 blog</h3> <div class="site-navigation"> <p><strong>Site Map</strong></p> <ul class="pages"> <li class="nav-link"> <a href="/archives">Archives</a> </li> <li class="nav-link"> <a href="/privacy">Privacy Policy</a> </li> <li class="nav-link"> <a href="/profile">Profile</a> </li> <li class="nav-link"> <a href="/profile/resume">Resume</a> </li> </ul> </div> <div class="site-contact"> <p><strong>Contact</strong></p> <ul class="social-media-list"> <li> <a href="https://twitter.com/kenchan0130" title="Follow me on Twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> <span class="username">kenchan0130</span> </a> </li> <li> <a href="https://github.com/kenchan0130" title="Fork me on GitHub" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> <span class="username">kenchan0130</span> </a> </li> </ul> </div> <div class="site-signature"> <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p> <p class="text">ソフトウェアエンジニア。記録に残したいことを雑に備忘するブログ。 投稿内容は個人の見解であり所属する組織の公式見解ではありません。 </p> </div> </div> <div class="licence">このサイトのコンテンツは<a href="https://creativecommons.org/licenses/by/4.0/deed.ja" target="_blank" rel="noopener noreferrer">Creative Commons Attribution 4.0 International (CC-BY-4.0) License</a>の下でライセンスされています。</div> <div class="copyright">Copyright © 2017-2025 Tadayuki Onishi All Rights Reserved.</div> </footer> <script src="/assets/bundle/app.55445db2fff8ddfed8c5.js" async></script> <script async src="//www.googletagmanager.com/gtag/js?id=G-B7RX34Q5PL"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-B7RX34Q5PL");</script> <script async src="//www.googletagmanager.com/gtag/js?id=UA-79827366-2"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-79827366-2");</script> </body> </html>