<!DOCTYPE html> <html> <!-- This page is used centrarium Jekyll theme Copyright (c) 2015 Ben Centra Released under the MIT license https://github.com/bencentra/centrarium/blob/daa0d16ba9156ad43f9980e2075023a0d48859a5/LICENSE.md --> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"> <title>Rails 5アップグレードへの道</title> <meta name="description" content="Railsのメジャーバージョンアップは毎回大幅なアップデートが含まれているため、アップグレード作業がたいへんになることがあります。 今回はとあるアプリケーションをRails 4.2.xからRails 5.0.0.1へアップグレードしたので、その記録を備忘として残しておきます。"> <meta name="author" content="Tadayuki Onishi"> <meta name="copyright" content="© Tadayuki Onishi 2025"> <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon"> <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon"> <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png"> <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png"> <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png"> <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png"> <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png"> <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png"> <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/android-icon-192x192.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png"> <link rel="manifest" href="/assets/icons/manifest.json"> <meta name="msapplication-TileColor" content="#ffffff"> <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png"> <meta name="theme-color" content="#ffffff"> <meta property="fb:app_id" content="376889769419405"> <meta property="og:description" content="Railsのメジャーバージョンアップは毎回大幅なアップデートが含まれているため、アップグレード作業がたいへんになることがあります。 今回はとあるアプリケーションをRails 4.2.xからRails 5.0.0.1へアップグレードしたので、その記録を備忘として残しておきます。"> <meta property="og:url" content="https://kenchan0130.github.io/post/2020-07-07-1"> <meta property="og:site_name" content="kenchan0130 blog"> <meta property="og:title" content="Rails 5アップグレードへの道"> <meta property="og:type" content="website"> <meta property="og:author" content="Tadayuki Onishi"> <meta property="og:image" content="https://kenchan0130.github.io/assets/logo.png"> <meta property="og:image:width" content="760"> <meta property="og:image:height" content="760"> <meta property="og:image:type" content="image/png"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="Rails 5アップグレードへの道"> <meta name="twitter:site" content="@kenchan0130"> <meta name="twitter:description" content="Railsのメジャーバージョンアップは毎回大幅なアップデートが含まれているため、アップグレード作業がたいへんになることがあります。 今回はとあるアプリケーションをRails 4.2.xからRails 5.0.0.1へアップグレードしたので、その記録を備忘として残しておきます。"> <meta name="twitter:image" content="https://kenchan0130.github.io/assets/logo.png"> <meta name="twitter:url" content="https://kenchan0130.github.io/post/2020-07-07-1"> <link rel="preload" as="style" href="/assets/bundle/app.6b4bd929e0a1773ddf90.css" onload="this.onload=null;this.rel='stylesheet'"> <noscript> <link rel="stylesheet" href="/assets/bundle/app.6b4bd929e0a1773ddf90.css"> </noscript> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="https://kenchan0130.github.io/post/2020-07-07-1"> <link rel="alternate" type="application/atom+xml" title="kenchan0130 blog" href="https://kenchan0130.github.io/feed.xml"> <meta name="google-site-verification" content="ZxlKORgZZwZ4TTmaQJFFEXLF3jmd6P_NVU9TEVW1bSg"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> </head> <body> <header class="navigation" role="banner"> <div class="navigation-wrapper"> <a href="/" class="logo"> <img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="kenchan0130 blog" data-src="/assets/logo.png" class="lazyload"> </a> <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu"> <i class="fas fa-bars"></i> </a> <nav role="navigation"> <ul id="js-navigation-menu" class="navigation-menu"> <li class="nav-search-box"> <div class="search-input-container"> <input type="search" class="search-input" id="js-search-input" placeholder="Search" autocomplete="off" onfocus="gtag('event', 'search', { event_category: 'www.algolia.com/apps/DEFR5IK9E2/explorer/browse/kenchan0130_blog', event_label: '/post/2020-07-07-1' });"> <i class="fa fa-search search-input-icon"></i> <template id="suggestion-template"> <a href="" onclick="gtag('event', 'click', { event_category: 'www.algolia.com/apps/DEFR5IK9E2/explorer/browse/kenchan0130_blog', event_label: this.href });"> <p class="suggestion-title js-suggestion-title"></p> <p class="suggestion-content js-suggestion-content"></p> </a> </template> </div> </li> <li class="nav-link"> <a href="/archives">Archives</a> </li> <li class="nav-link"> <a href="/profile">Profile</a> </li> </ul> </nav> </div> </header> <div class="page-content"> <div class="post"> <div class="post-header-container "> <div class="scrim "> <header class="post-header"> <h1 class="title">Rails 5アップグレードへの道</h1> </header> </div> </div> <div class="wrapper"> <span class="page-divider"> <span class="one"></span> <span class="two"></span> </span> <section class="post-meta"> <div class="post-date">2020-07-07</div> <div class="post-categories"> <i class="fas fa-fw fa-book"></i> <a href="/category/development">development </a> </div> </section> <article class="post-content"> <p>この記事はQiitaに投稿した内容を一部加筆修正し、移行してきたものです。</p> <p>Railsのメジャーバージョンアップは毎回大幅なアップデートが含まれているため、アップグレード作業がたいへんになることがあります。</p> <p>今回はとあるアプリケーションをRails 4.2.xからRails 5.0.0.1へアップグレードしたので、その記録を備忘として残しておきます。</p> <ul id="markdown-toc"> <li><a href="#%E5%89%8D%E6%8F%90" id="markdown-toc-前提">前提</a></li> <li><a href="#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A2%E3%83%83%E3%83%97" id="markdown-toc-ライブラリのバーションアップ">ライブラリのバーションアップ</a></li> <li><a href="#rails-5%E3%81%AEgem%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" id="markdown-toc-rails-5のgemをインストール">Rails 5のgemをインストール</a></li> <li><a href="#rails%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%AE%E6%9B%B4%E6%96%B0" id="markdown-toc-railsアプリケーションの設定の更新">Railsアプリケーションの設定の更新</a></li> <li> <a href="#%E5%90%84%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E8%AA%BF%E6%95%B4" id="markdown-toc-各ファイルの調整">各ファイルの調整</a> <ul> <li><a href="#xxxbase%E3%81%AE%E7%B6%99%E6%89%BF%E3%81%8C%E5%A4%89%E6%9B%B4" id="markdown-toc-xxxbaseの継承が変更">xxx::Baseの継承が変更</a></li> <li><a href="#xxx_filter%E3%81%AE%E9%9D%9E%E6%8E%A8%E5%A5%A8" id="markdown-toc-xxx_filterの非推奨">xxx_filterの非推奨</a></li> <li><a href="#env%E3%81%AE%E7%9B%B4%E6%8E%A5%E5%8F%82%E7%85%A7%E3%81%8C%E9%9D%9E%E6%8E%A8%E5%A5%A8" id="markdown-toc-envの直接参照が非推奨">envの直接参照が非推奨</a></li> <li><a href="#plaintext%E3%81%AE%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E6%96%B9%E6%B3%95%E3%81%8C%E5%A4%89%E6%9B%B4" id="markdown-toc-plaintextのレンダリング方法が変更">plain/textのレンダリング方法が変更</a></li> <li><a href="#responseheaders%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E5%A4%89%E6%9B%B4" id="markdown-toc-responseheadersのオブジェクトの変更">response.headersのオブジェクトの変更</a></li> <li><a href="#responseheaders-api%E3%81%AE%E6%B6%88%E5%A4%B1" id="markdown-toc-responseheaders-apiの消失">response.headers= APIの消失</a></li> <li><a href="#errors%E3%81%AE%E9%9D%9E%E6%8E%A8%E5%A5%A8" id="markdown-toc-errorsの非推奨">errors[]の非推奨</a></li> <li><a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AEjson%E3%83%91%E3%83%BC%E3%82%B5%E3%81%AE%E7%8B%AC%E8%87%AA%E5%AE%9A%E7%BE%A9%E6%96%B9%E6%B3%95%E3%81%AE%E5%A4%89%E6%9B%B4" id="markdown-toc-リクエストのjsonパーサの独自定義方法の変更">リクエストのJSONパーサの独自定義方法の変更</a></li> <li><a href="#activerecordmigration%E3%81%AB%E3%83%90%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%8C%87%E5%AE%9A%E3%81%8C%E8%BF%BD%E5%8A%A0" id="markdown-toc-activerecordmigrationにバーション指定が追加">ActiveRecord::Migrationにバーション指定が追加</a></li> <li><a href="#json%E3%81%8A%E3%82%88%E3%81%B3jsonb%E5%9E%8B%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%8C%E5%AD%98%E5%9C%A8%E3%81%99%E3%82%8B%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%99%82%E3%81%AB%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E5%80%A4%E3%81%AE%E8%A7%A3%E9%87%88%E3%81%8C%E5%A4%89%E6%9B%B4" id="markdown-toc-jsonおよびjsonb型カラムが存在するテーブルのマイグレーション時にデフォルト値の解釈が変更">jsonおよびjsonb型カラムが存在するテーブルのマイグレーション時にデフォルト値の解釈が変更</a></li> <li><a href="#alias_method_chain%E3%81%AE%E4%BD%BF%E7%94%A8%E3%81%8C%E9%9D%9E%E6%8E%A8%E5%A5%A8" id="markdown-toc-alias_method_chainの使用が非推奨">alias_method_chainの使用が非推奨</a></li> <li><a href="#actioncontrollertestcase%E3%81%8C%E9%9D%9E%E6%8E%A8%E5%A5%A8" id="markdown-toc-actioncontrollertestcaseが非推奨">ActionController::TestCaseが非推奨</a></li> <li><a href="#%E3%83%9F%E3%83%89%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%AE%E5%B7%AE%E3%81%97%E8%BE%BC%E3%81%BF%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E5%90%8D%E3%81%AE%E6%96%87%E5%AD%97%E5%88%97%E6%8C%87%E5%AE%9A%E3%81%8C%E9%9D%9E%E6%8E%A8%E5%A5%A8" id="markdown-toc-ミドルウェアの差し込みのクラス名の文字列指定が非推奨">ミドルウェアの差し込みのクラス名の文字列指定が非推奨</a></li> <li><a href="#actioncontrollerparameters%E3%81%8Chash%E7%B6%99%E6%89%BF%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F" id="markdown-toc-actioncontrollerparametersがhash継承ではなくなった">ActionController::ParametersがHash継承ではなくなった</a></li> </ul> </li> <li><a href="#%E3%81%BE%E3%81%A8%E3%82%81" id="markdown-toc-まとめ">まとめ</a></li> </ul> <h2 id="前提">前提</h2> <p>Rubyのバージョンが <code class="language-plaintext highlighter-rouge">2.2.2</code> 以上でなければ、Rails 5は動作しません。</p> <p><code class="language-plaintext highlighter-rouge">2.2.2</code> 未満を使用している場合は、まずRubyのバージョンをアップデートしてからRailsのアップデートを行うことをオススメします。</p> <h2 id="ライブラリのバーションアップ">ライブラリのバーションアップ</h2> <p>Rails 4系に依存しているライブラリをRails 5系に対応しているものにしたいため、</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle update
</code></pre></div></div> <p>を行います。</p> <p>この方法はすべてのgemをアップデートしてしまうため、関連するものだけをアップデートしたい場合は個別に指定してください。</p> <p>Rails 5へのアップグレードの原因切り分けのため、この時点でご自身のRailsアプリケーションのテストがすべて通過していることを確認します。</p> <h2 id="rails-5のgemをインストール">Rails 5のgemをインストール</h2> <p><code class="language-plaintext highlighter-rouge">Gemfile</code> の <code class="language-plaintext highlighter-rouge">rails</code> の項目を、以下のように変更します。</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'5.0.0.1'</span>
</code></pre></div></div> <p>変更を保存したら、</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle update rails
</code></pre></div></div> <p>のコマンドを実行し、アップデートを行います。</p> <p>これでうまくアップデートできない場合、依存しているライブラリがRails 5対応していないと考えられます。</p> <p>その場合はIssue立てるなりPull Requestを出すなりして対応するのが良いでしょう。</p> <h2 id="railsアプリケーションの設定の更新">Railsアプリケーションの設定の更新</h2> <p>Railsの設定項目にいくつか追加および変更があります。 Railsにはこの更新をサポートしてくれるコマンドが用意されています。</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails app:update
</code></pre></div></div> <p>上記のコマンドを実行すると差分が表示されるので、問題なければ上書きを、問題ありそうであれば、うまく差分を吸収していきましょう。</p> <p><code class="language-plaintext highlighter-rouge">routes.rb</code>や<code class="language-plaintext highlighter-rouge">application.rb</code>などにも変更が入るため、特に注意しましょう。</p> <h2 id="各ファイルの調整">各ファイルの調整</h2> <p>上記の変更したら一度テストを実行しましょう。 テストが通れば問題ないのですが、いくつかのAPIが変更されているため、そうは問屋が卸さない感じでした。</p> <p>アプリケーションのファイルにも少し手を加える必要が出てきます。 また、多数の<code class="language-plaintext highlighter-rouge">DEPRECATION WARNING</code>が出てくると思われますので、地道に1つずつ潰していきましょう。</p> <h3 id="xxxbaseの継承が変更">xxx::Baseの継承が変更</h3> <ul> <li> <code class="language-plaintext highlighter-rouge">ActiveRecord::Base</code> -&gt; <code class="language-plaintext highlighter-rouge">ApplicationRecord</code> </li> <li> <code class="language-plaintext highlighter-rouge">ActiveJob::Base</code> -&gt; <code class="language-plaintext highlighter-rouge">ApplicationJob</code> </li> <li> <code class="language-plaintext highlighter-rouge">ActionMailer::Base</code> -&gt; <code class="language-plaintext highlighter-rouge">ApplicationMailer</code> </li> </ul> <p>上記の3つが直接継承からもう一層挟むようになりました。 これでBaseクラスにモンキーパッチ当てるような処理をせずに済むようになります。</p> <p>ただ、このままだと<code class="language-plaintext highlighter-rouge">ApplicationRecord</code>がテーブルとして認識されてしまいます。</p> <h4 id="xxxbaseの継承が変更---対応方法">xxx::Baseの継承が変更 - 対応方法</h4> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># application_record.rb</span>
<span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div> <p>上記のように<code class="language-plaintext highlighter-rouge">self.abstract_class = true</code>を記載することでテーブルとして認識されなくなります。</p> <h3 id="xxx_filterの非推奨">xxx_filterの非推奨</h3> <p>Controllerで使用される<code class="language-plaintext highlighter-rouge">before_filter</code>や<code class="language-plaintext highlighter-rouge">after_filter</code>などが非推奨になりました。</p> <h4 id="xxx_filterの非推奨---対応方法">xxx_filterの非推奨 - 対応方法</h4> <ul> <li> <code class="language-plaintext highlighter-rouge">before_filter</code> -&gt; <code class="language-plaintext highlighter-rouge">before_action</code> </li> <li> <code class="language-plaintext highlighter-rouge">after_filter</code> -&gt; <code class="language-plaintext highlighter-rouge">after_action</code> </li> </ul> <p>新たに上記のように<code class="language-plaintext highlighter-rouge">xxx_action</code>が用意されているので、こちらに変更しましょう。</p> <h3 id="envの直接参照が非推奨">envの直接参照が非推奨</h3> <p><code class="language-plaintext highlighter-rouge">ActionController</code>を継承したクラス内での<code class="language-plaintext highlighter-rouge">env</code>を使用して、rack の<code class="language-plaintext highlighter-rouge">env</code>へのアクセスが非推奨となりました。</p> <h4 id="envの直接参照が非推奨---対応方法">envの直接参照が非推奨 - 対応方法</h4> <p><code class="language-plaintext highlighter-rouge">request.env</code>から取得できるようになっているので、こちらに変更しましょう。</p> <h3 id="plaintextのレンダリング方法が変更">plain/textのレンダリング方法が変更</h3> <p><code class="language-plaintext highlighter-rouge">plain/text</code>でレンダリングする場合、<code class="language-plaintext highlighter-rouge">render text: "This is a text."</code>での指定が非推奨となりました。</p> <h4 id="plaintextのレンダリング方法が変更---対応方法">plain/textのレンダリング方法が変更 - 対応方法</h4> <p><code class="language-plaintext highlighter-rouge">render plain: "This is a text."</code>に変更しましょう。</p> <h3 id="responseheadersのオブジェクトの変更">response.headersのオブジェクトの変更</h3> <p><code class="language-plaintext highlighter-rouge">response.headers</code>はRails 4までは<code class="language-plaintext highlighter-rouge">Hash</code>オブジェクトでしたが、Rails 5からは<code class="language-plaintext highlighter-rouge">ActionDispatch::Response::Header</code>オブジェクトに変更になりました。 <code class="language-plaintext highlighter-rouge">ActionDispatch::Response::Header</code>は<code class="language-plaintext highlighter-rouge">DelegateClass(Hash)</code>を継承しているので、<code class="language-plaintext highlighter-rouge">Hash</code>オブジェクトの子クラスではありません。 そのため、たとえば</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">).</span><span class="nf">to</span> <span class="kp">include</span> <span class="p">{</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s1">'Bearer sample_token'</span> <span class="p">}</span>
</code></pre></div></div> <p>のように<code class="language-plaintext highlighter-rouge">Hash</code>オブジェクトとして扱っていた場合などに影響が出てきます。</p> <h4 id="responseheadersのオブジェクトの変更---対応方法">response.headersのオブジェクトの変更 - 対応方法</h4> <p><code class="language-plaintext highlighter-rouge">Hash</code>オブジェクトとして扱いたい場合は、<code class="language-plaintext highlighter-rouge">response.headers.to_h</code>のように<code class="language-plaintext highlighter-rouge">.to_h</code>メソッドを呼び出して<code class="language-plaintext highlighter-rouge">Hash</code>オブジェクトに変換しましょう。</p> <h3 id="responseheaders-apiの消失">response.headers= APIの消失</h3> <p><code class="language-plaintext highlighter-rouge">response.headers=</code>のAPIがなくなりました。 そのため、レスポンスヘッダをまとめて直接変更できなくなってしまいました。</p> <h4 id="responseheaders-apiの消失---対応方法">response.headers= APIの消失 - 対応方法</h4> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'HEADER NAME'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'HEADER VALUE'</span>
<span class="c1"># or</span>
<span class="n">response</span><span class="p">.</span><span class="nf">set_header</span><span class="p">(</span><span class="s1">'HEADER NAME'</span><span class="p">,</span> <span class="s1">'HEADER VALUE'</span><span class="p">)</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">response.headers[]</code>または<code class="language-plaintext highlighter-rouge">response.set_header</code>を使用して1つずつ変更していきましょう。</p> <h3 id="errorsの非推奨">errors[]の非推奨</h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">errors</span><span class="p">[</span><span class="ss">:base</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"This is invalid!"</span>
</code></pre></div></div> <p>上記のようにモデルの<code class="language-plaintext highlighter-rouge">errors[]</code>を使用してのエラーの追加が非推奨となりました。</p> <h4 id="errorsの非推奨---対応方法">errors[]の非推奨 - 対応方法</h4> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:base</span><span class="p">,</span> <span class="s2">"This is invalid!"</span><span class="p">)</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">errors.add</code>を使用しましょう。</p> <h3 id="リクエストのjsonパーサの独自定義方法の変更">リクエストのJSONパーサの独自定義方法の変更</h3> <p>今までリクエストのJSONパーサを独自に定義する場合、</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">swap</span><span class="p">(</span>
  <span class="o">::</span><span class="no">ActionDispatch</span><span class="o">::</span><span class="no">ParamsParser</span><span class="p">,</span> <span class="o">::</span><span class="no">ActionDispatch</span><span class="o">::</span><span class="no">ParamsParser</span><span class="p">,</span>
  <span class="o">::</span><span class="no">Mime</span><span class="o">::</span><span class="no">JSON</span> <span class="o">=&gt;</span> <span class="nb">proc</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw_post</span><span class="o">|</span>
    <span class="o">::</span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">JSON</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">raw_post</span><span class="p">).</span><span class="nf">with_indifferent_access</span>
  <span class="k">end</span>
<span class="p">)</span>
</code></pre></div></div> <p>のようにミドルウェアにかます方法が利用できましたが、この方法が使用できなくなりました。</p> <h4 id="リクエストのjsonパーサの独自定義方法の変更---対応方法">リクエストのJSONパーサの独自定義方法の変更 - 対応方法</h4> <p><code class="language-plaintext highlighter-rouge">ActionDispatch::Request.parameter_parsers</code>にパーサの定義が入るようになったため、</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">parameter_parsers</span><span class="p">[</span><span class="ss">:json</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">raw_post</span><span class="p">)</span> <span class="k">do</span>
  <span class="o">::</span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">JSON</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">raw_post</span><span class="p">).</span><span class="nf">with_indifferent_access</span>
<span class="k">end</span>
</code></pre></div></div> <p>のようにJSONパーサを定義（代入）するようにしましょう。</p> <h3 id="activerecordmigrationにバーション指定が追加">ActiveRecord::Migrationにバーション指定が追加</h3> <p><code class="language-plaintext highlighter-rouge">ActiveRecord::Migration</code>にバージョンの指定が必要になりました。</p> <p>production環境では過去のマイグレーションファイルにバーションが指定されていなくても問題ないのですが、CIでのテストなど、データベースがリセットされており、都度マイグレーションを走らせると警告が出てしまいます。</p> <h4 id="activerecordmigrationにバーション指定が追加---対応方法">ActiveRecord::Migrationにバーション指定が追加 - 対応方法</h4> <p>すでに存在するマイグレーションファイルの<code class="language-plaintext highlighter-rouge">ActiveRecord::Migration</code>を<code class="language-plaintext highlighter-rouge">ActiveRecord::Migration[4.2]</code>に変更しましょう。</p> <h3 id="jsonおよびjsonb型カラムが存在するテーブルのマイグレーション時にデフォルト値の解釈が変更">jsonおよびjsonb型カラムが存在するテーブルのマイグレーション時にデフォルト値の解釈が変更</h3> <p>今まではjsonおよびjsonb型カラムのデフォルト値にオブジェクトを入れる際は、</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create_table</span> <span class="ss">:posts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">jsonb</span> <span class="ss">:settings</span><span class="p">,</span> <span class="ss">default: </span><span class="s1">'{}'</span>
<span class="k">end</span>
</code></pre></div></div> <p>のように文字列で指定していましたが、このオブジェクトの指定がシリアライズされずに設定されるようになりました。</p> <p>production環境では、過去のマイグレーションファイルに対してこの対応しなくても影響はないですが、開発時に</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails db:migrate:reset
</code></pre></div></div> <p>などを実行する場合 <code class="language-plaintext highlighter-rouge">scheme.rb</code> が更新されてしまいます。</p> <h4 id="jsonおよびjsonb型カラムが存在するテーブルのマイグレーション時にデフォルト値の解釈が変更---対応方法">jsonおよびjsonb型カラムが存在するテーブルのマイグレーション時にデフォルト値の解釈が変更 - 対応方法</h4> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create_table</span> <span class="ss">:posts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">jsonb</span> <span class="ss">:settings</span><span class="p">,</span> <span class="ss">default: </span><span class="p">{}</span>
<span class="k">end</span>
</code></pre></div></div> <p>Rubyの空ハッシュオブジェクトを、デフォルト値として設定するようにしましょう。</p> <h3 id="alias_method_chainの使用が非推奨">alias_method_chainの使用が非推奨</h3> <p>モンキーパッチなどを行う際、モンキーパッチする前のメソッドを参照できるように<code class="language-plaintext highlighter-rouge">alias_method_chain</code>というメソッドが用意されてしましたが、非推奨になりました。</p> <h4 id="alias_method_chainの使用が非推奨---対応方法">alias_method_chainの使用が非推奨 - 対応方法</h4> <p><code class="language-plaintext highlighter-rouge">Object.prepend</code>を使用するようにしましょう。 具体的な例についてはTechscoreさんの<a href="http://www.techscore.com/blog/2013/01/22/ruby2-0%E3%81%AEmodule-prepend%E3%81%AF%E5%A6%82%E4%BD%95%E3%81%AB%E3%81%97%E3%81%A6alias_method_chain%E3%82%92%E6%92%B2%E6%BB%85%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B%EF%BC%81%EF%BC%9F/" target="_blank" rel="noopener noreferrer">Ruby2.0のModule#prependは如何にしてalias_method_chainを撲滅するのか！？</a>に詳しく書かれています。</p> <h3 id="actioncontrollertestcaseが非推奨">ActionController::TestCaseが非推奨</h3> <p>クラス名を言われても何を指しているのかピンと来ないかもしれませんが、ControllerやHTTP Requestのテストの際に、</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="k">def</span> <span class="nf">test_post</span>
    <span class="n">post</span> <span class="s1">'/post'</span><span class="p">,</span> <span class="p">{</span> <span class="ss">title: </span><span class="s1">'sample'</span> <span class="p">},</span> <span class="p">{</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s1">'Bearer sample_token'</span> <span class="p">}</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>上記のようにテストを実現していました。 このAPIが変更になりました。</p> <h4 id="actioncontrollertestcaseが非推奨---対応方法">ActionController::TestCaseが非推奨 - 対応方法</h4> <p><code class="language-plaintext highlighter-rouge">ActionDispatch::IntegrationTest</code> を使用しましょう。</p> <p>具体的には、</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="k">def</span> <span class="nf">test_post</span>
    <span class="n">post</span> <span class="s1">'/post'</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">title: </span><span class="s1">'sample'</span> <span class="p">},</span> <span class="ss">headers: </span><span class="p">{</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s1">'Bearer sample_token'</span> <span class="p">}</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>としましょう。また、HTTPリクエストメソッドは、パス以外はすべてキーワード引数を受け取るようになりました。</p> <h3 id="ミドルウェアの差し込みのクラス名の文字列指定が非推奨">ミドルウェアの差し込みのクラス名の文字列指定が非推奨</h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'Rack::Cors'</span> <span class="k">do</span>
<span class="k">end</span>
</code></pre></div></div> <p>今まで読み込み順の関係もあり、クラス名を指定する場合は文字列で指定している方が多かったかと思いますが、この方法が非推奨になりました。</p> <h4 id="ミドルウェアの差し込みのクラス名の文字列指定が非推奨---対応方法">ミドルウェアの差し込みのクラス名の文字列指定が非推奨 - 対応方法</h4> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span> <span class="mi">0</span><span class="p">,</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cors</span> <span class="k">do</span>
<span class="k">end</span>
</code></pre></div></div> <p>クラス名をオブジェクトの状態で渡しましょう。</p> <h3 id="actioncontrollerparametersがhash継承ではなくなった">ActionController::ParametersがHash継承ではなくなった</h3> <p><code class="language-plaintext highlighter-rouge">ActionController::Parameters</code>が<code class="language-plaintext highlighter-rouge">Hash</code>クラスの継承でなくなりました。 入れ子になっているパラメータ（オブジェクト）も <code class="language-plaintext highlighter-rouge">ActionController::Parameters</code>オブジェクトになっています。</p> <p><code class="language-plaintext highlighter-rouge">params.merge</code>は必ず引数に<code class="language-plaintext highlighter-rouge">Hash</code>オブジェクトを取るようになったため気を付ける必要があります。</p> <p>また、<code class="language-plaintext highlighter-rouge">to_h</code>メソッドは<code class="language-plaintext highlighter-rouge">Hash</code>オブジェクトに変換するわけではなく、</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">params</span><span class="p">[</span><span class="ss">:title</span><span class="p">]</span>
<span class="c1"># =&gt; 'hoge'</span>
<span class="n">params</span><span class="p">[</span><span class="ss">:sub_title</span><span class="p">]</span>
<span class="c1"># =&gt; 'fuga'</span>
<span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">).</span><span class="nf">to_h</span>
<span class="c1"># =&gt; { 'title' =&gt; 'hoge' }</span>
</code></pre></div></div> <p>上記のようにpermittedなパラメータのみが<code class="language-plaintext highlighter-rouge">Hash</code>オブジェクトになります。</p> <p>今回の変更で一番の鬼門はこの変更であると個人的に思っています。</p> <h4 id="actioncontrollerparametersがhash継承ではなくなった---対応方法">ActionController::ParametersがHash継承ではなくなった - 対応方法</h4> <p><code class="language-plaintext highlighter-rouge">ActionController::Parameters</code>同士をマージする際は<code class="language-plaintext highlighter-rouge">Hash</code>オブジェクトに変換してください。</p> <p>キーが不定なパラメータを受け取る場合は、<code class="language-plaintext highlighter-rouge">to_unsafe_h</code>というメソッドが用意されているのでこちらを使用します。</p> <p>「unsafe」とあるように、安全でない可能性があるため、用法用量を守り正しくお使いください。</p> <h2 id="まとめ">まとめ</h2> <p>Rails 5にすることで、さまざまな新機能が使用できます。 個人的には、</p> <ul> <li>ORクエリの発行 <ul> <li>合わせてポリモーフィックなモデルのクエリの改善</li> </ul> </li> <li><code class="language-plaintext highlighter-rouge">ActionCable</code></li> <li><code class="language-plaintext highlighter-rouge">rails-api</code></li> <li>マイグレーションのMySQLの大幅サポート</li> </ul> <p>あたりが、直近恩恵を受けています。</p> <p>一部ベンチマークによると、Active Record周りなど少し遅くなったりしているようですが、マイナーおよびパッチバージョンアップで改善されると思われます。</p> <p>みなさんもRails 5にアップグレードをして、ステキなRails 5ライフをお送りください。</p> </article> <section class="share"> <a href="//twitter.com/share?text=Rails+5%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89%E3%81%B8%E3%81%AE%E9%81%93&amp;url=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2020-07-07-1%3Futm_source%3Dtwitter%26utm_medium%3Dsocial&amp;via=kenchan0130" onclick="window.open(this.href, 'twitter-share', 'width=550,height=255,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-twitter fa-lg"></i> </a> <a href="//www.facebook.com/sharer.php?t=Rails+5%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89%E3%81%B8%E3%81%AE%E9%81%93&amp;u=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2020-07-07-1%3Futm_source%3Dfacebook%26utm_medium%3Dsocial" onclick="window.open(this.href, 'facebook-share', 'width=550,height=255,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-facebook fa-lg"></i> </a> <a href="//b.hatena.ne.jp/entry/panel/?btitle=Rails+5%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89%E3%81%B8%E3%81%AE%E9%81%93&amp;url=https%3A%2F%2Fkenchan0130.github.io%2Fpost%2F2020-07-07-1" onclick="window.open(this.href, 'hatena-share', 'width=550,height=600,menubar=no,toolbar=no,resizable=yes');return false;"> <i class="fab fa-hatena fa-lg"></i> </a> </section> <section class="post-donation"> <div class="post-donation-panel"> <p class="post-donation-description"> 参考になった・面白かったと感じていただけましたら、サポートいただけると励みになります。 </p> <a class="post-donation-button" href="https://www.buymeacoffee.com/kenchan0130" onclick="gtag('event', 'click-buymeacoffee', { event_category: 'www.buymeacoffee.com/kenchan0130', event_label: '/post/2020-07-07-1' });" target="_blank" rel="noopener noreferrer"> <p class="post-donation-button-body"> <img class="icon lazyload" alt="buymeacoffee" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg"> <span class="label">サポートする</span> </p> </a> </div> </section> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2444060431947599" data-ad-slot="7319689305" data-ad-format="auto"></ins> <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script> <section class="sub-contents related-posts"> <div class="sub-contents-wrapper"> <div class="sub-contents-title">あわせて読みたい</div> <div class="sub-contents-main"> <li> <a href="/post/2020-07-17-1">RailsでJSONのリクエストパラメータがパースできなかった場合の対応</a> <span class="post-date">- July 17, 2020</span> </li> <li> <a href="/post/2018-07-30-1">Jekyllの画像遅延ロードのためのライブラリを作った</a> <span class="post-date">- July 30, 2018</span> </li> </div> </div> </section> <section class="sub-contents tags"> <div class="sub-contents-wrapper"> <div class="sub-contents-title">Tags</div> <div class="sub-contents-main"> <a href="/tag/ruby">Ruby</a> <a href="/tag/rails">Rails</a> </div> </div> </section> </div> </div> </div> <footer class="site-footer"> <div class="wrapper"> <h3 class="footer-heading">kenchan0130 blog</h3> <div class="site-navigation"> <p><strong>Site Map</strong></p> <ul class="pages"> <li class="nav-link"> <a href="/archives">Archives</a> </li> <li class="nav-link"> <a href="/privacy">Privacy Policy</a> </li> <li class="nav-link"> <a href="/profile">Profile</a> </li> <li class="nav-link"> <a href="/profile/resume">Resume</a> </li> </ul> </div> <div class="site-contact"> <p><strong>Contact</strong></p> <ul class="social-media-list"> <li> <a href="https://twitter.com/kenchan0130" title="Follow me on Twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> <span class="username">kenchan0130</span> </a> </li> <li> <a href="https://github.com/kenchan0130" title="Fork me on GitHub" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> <span class="username">kenchan0130</span> </a> </li> </ul> </div> <div class="site-signature"> <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p> <p class="text">ソフトウェアエンジニア。記録に残したいことを雑に備忘するブログ。 投稿内容は個人の見解であり所属する組織の公式見解ではありません。 </p> </div> </div> <div class="licence">このサイトのコンテンツは<a href="https://creativecommons.org/licenses/by/4.0/deed.ja" target="_blank" rel="noopener noreferrer">Creative Commons Attribution 4.0 International (CC-BY-4.0) License</a>の下でライセンスされています。</div> <div class="copyright">Copyright © 2017-2025 Tadayuki Onishi All Rights Reserved.</div> </footer> <script src="/assets/bundle/app.6b4bd929e0a1773ddf90.js" async></script> <script async src="//www.googletagmanager.com/gtag/js?id=G-B7RX34Q5PL"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-B7RX34Q5PL");</script> <script async src="//www.googletagmanager.com/gtag/js?id=UA-79827366-2"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-79827366-2");</script> </body> </html>