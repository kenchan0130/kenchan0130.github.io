---
title: Jamf ProとInstallomatorで常に最新のアプリケーションを配布
layout: post
outline: >
  TBD
categories:
  - system-administration
tags:
  - Apple
  - Installomator
  - Jamf Pro
  - macOS
  - MDM
  - Volume Purchase
---

管理下にあるmacOSのデバイスにおいて、

* 最新バーションのアプリケーションをインストールしたい
* アプリケーションを常に最新バージョンのアップデートしたい

という要件を実現したいことがあります。

Volume Purchase（旧VPP）を使用することで、App Storeのアプリケーションであればある程度実現できますが、サードパーティ製のアプリケーションでこれを実現するのが難しい状態でした。

今回は、[Jamf Pro](https://www.jamf.com/ja/products/jamf-pro)と[Installomator](https://github.com/scriptingosx/Installomator)を使用して、常に最新バージョンのアプリケーションを配布する方法を紹介します。

* TOC
{:toc}

## 最新バージョンのアプリケーションを配布する際の問題点

今まで最新バージョンのアプリケーションを配布するためには、アプリケーションのpkg（pkg化されていないアプリケーションはpkg化）ファイルをJamf Proにアップロードして、アップロードしたファイルをアサインした専用のポリシーを作成していました。

しかし、これでは対象のアプリケーションが更新された場合、管理者は新たなバーションのアプリケーションのpkgファイルをJamf Proにアップデートして配布するという運用が必要でした。
この運用はアプリケーションが少ないと回りますが、アプリケーションの数が増えてくると段々と運用を圧迫し最新バージョンがインストールされず、不具合や最悪の場合、脆弱性を突かれる可能性があります。

アプリケーションがApp Storeにも存在する場合は、Volume Purchaseに寄せることで、最新バージョンのインストールおよび自動アップデートが可能です。
しかし、Volume Purchaseのインストール、およびアップデート[^vp-update]の信頼性が低い状態が続いているという問題があります。[^vp-issue]

[^vp-update]: Volume Purchaseを介したアップデートは、対象のアプリケーションがmacOSのデバイス上で起動している場合、アップデートが行われない仕様です。
[^vp-issue]: [Mac Appstore apps not installing \| Jamf Nation](https://www.jamf.com/jamf-nation/discussions/31949/mac-appstore-apps-not-installing)や[MDMClientError:72 \| Jamf Nation](https://www.jamf.com/jamf-nation/discussions/33392/mdmclienterror-72)、[vpp redownload call timed out <mdmclienterror:72> \| Jamf Nation](https://www.jamf.com/jamf-nation/discussions/31057/vpp-redownload-call-timed-out-mdmclienterror-72)などでいくつか報告が上がっています。Jamf Proの問題ではなくApple側の問題であることが示唆されています。

## Installomatorとは

[Installomator](https://github.com/scriptingosx/Installomator)は、[Briegel](https://twitter.com/scriptingosx)氏が開発しているzsh製のスクリプトです。

インストール/アップデートしたいアプリケーションのラベルを指定すると、常に最新バージョンのアプリケーションがインストールされます。とてもシンプルです。

公証の確認を行っているため、macOSは**10.14.4以降**である必要があります。

## Installomatorのしくみ

ざっくりとInstallomatorのしくみを解説すると、以下のような処理が行われます。

1. インターネット上にホスティングされている最新版のアプリケーションのURLを特定
1. アプリケーションやインストーラをダウンロード
1. ダウンロードしてきたアプリケーションやインストーラの署名および公証の確認
1. ダウンロードしてきたアプリケーションやインストーラを解凍・展開
1. インストールの実行
1. 必要があればインストールが終わった旨の通知

インターネット上にホスティングされているアプリケーションやインストーラは偽物など、安全ではない可能性があります。
Jamf Proのポリシーなど、管理者特権で実行する場合は特に注意が必要ですが、これをクリアするために署名と公証を確認しています。

## InstallomatorをJamf Proに組み込む

### Installomatorスクリプトの取得

[InstallomatorのGitHubリポジトリ](https://github.com/scriptingosx/Installomator)の`Installomator.sh`が対象のスクリプトです。

デフォルトがdevブランチ、つまり開発中のブランチであるため、安定版が必要な場合は[リリース一覧](https://github.com/scriptingosx/Installomator/releases)より、最新版のソースコードから`Installomator.sh`を取得してください。

### InstallomatorスクリプトをJamf Proに登録


## おすすめの構成

## 必要なアプリケーションがInstallomatorに存在しなかった場合

## 注意点

Installomatorではいくつかのアプリケーションの最新バージョンを特定するために、GitHub APIを使用しています。
APIトークンを使用しない呼び出し方をしているため、同一IPで1時間に60リスエストの制限があります。

[GitHub APIトークンサポートのissue](https://github.com/scriptingosx/Installomator/issues/23)を挙げていますので、もし必要だと感じられましたら、賛同のコメントやリアクションまたはPull Requestをお待ちしています！

## 終わりに
